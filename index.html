<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eventos Adm Valente</title>
    <meta name="description" content="Gerenciador de Agenda Administrativa">
    <meta name="theme-color" content="#003366">
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        html, body, * { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-navy { background-color: #003366; } .text-navy { color: #003366; } .border-navy { border-color: #003366; } .hover-bg-navy-dark:hover { background-color: #002855; }
        .bg-orange-custom { background-color: #FF8C00; } .text-orange-custom { color: #FF8C00; } .border-orange-custom { border-color: #FF8C00; } .hover-bg-orange-dark:hover { background-color: #e67e00; }
        .animate-in { animation-duration: 0.2s; animation-fill-mode: both; }
        .fade-in { animation-name: fadeIn; } .zoom-in { animation-name: zoomIn; } .slide-in { animation: slideIn 0.3s ease-out; } .slide-in-from-top-2 { animation: slideInTop 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } } @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } } @keyframes slideInTop { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        input:focus, select:focus, textarea:focus { outline: none; } input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus { -webkit-box-shadow: 0 0 0 30px white inset !important; }
        .disabled-area { opacity: 0.5; pointer-events: none; filter: grayscale(1); } .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; animation: shake 0.3s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
    </style>
    
    <script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "firebase/": "https://esm.sh/firebase@^12.6.0/"
  }
}
</script>
</head>
<body class="h-screen w-full flex flex-col bg-slate-100">

    <div id="app" class="flex-1 w-full h-full relative overflow-hidden flex flex-col">
        <div class="flex items-center justify-center h-full text-slate-400">
            <div class="flex flex-col items-center gap-2">
                <div class="w-8 h-8 border-4 border-navy border-t-transparent rounded-full animate-spin"></div>
                <span class="text-sm font-medium">Carregando Agenda...</span>
            </div>
        </div>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>

    <template id="login-modal-template">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in">
            <div class="p-5 border-b border-slate-100 bg-slate-50">
                <h3 class="font-bold text-lg text-navy">Área Administrativa</h3>
            </div>
            <form id="login-form" class="p-6 flex flex-col gap-4">
                <div><label class="text-sm font-bold text-slate-700 mb-1 block">Email</label><input type="email" id="login-email" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-navy/20 focus:border-navy" required></div>
                <div><label class="text-sm font-bold text-slate-700 mb-1 block">Senha</label><input type="password" id="login-password" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-navy/20 focus:border-navy" required></div>
                <div id="login-error" class="text-red-500 text-sm hidden font-medium"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 rounded-lg text-slate-600 bg-slate-100 hover:bg-slate-200 font-bold">Cancelar</button>
                    <button type="submit" class="flex-1 py-3 rounded-lg bg-navy text-white hover:bg-navy-dark font-bold shadow-lg shadow-blue-900/20">Entrar</button>
                </div>
            </form>
        </div>
    </template>

    <script type="module">
        import { initializeApp, getApps, getApp } from "firebase/app";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy, enableIndexedDbPersistence } from "firebase/firestore";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "firebase/auth";

        const firebaseConfig = { apiKey: "AIzaSyCmceNv1eBJLj7aWMcR7crvSVxonuzDVQo", authDomain: "agendaadmvalente.firebaseapp.com", projectId: "agendaadmvalente", storageBucket: "agendaadmvalente.firebasestorage.app", messagingSenderId: "810572581910", appId: "1:810572581910:web:155a7e18f6c46f77faf937" };
        const ADMIN_UID = "kRzVsk2nqNTyj79Lk4h6Fmhk7JP2";
        
        const appInfo = getApps().length > 0 ? getApp() : initializeApp(firebaseConfig);
        const db = getFirestore(appInfo);
        const auth = getAuth(appInfo);

        async function initPersistence() {
            try { await enableIndexedDbPersistence(db); console.log("Persistência offline ativada."); } 
            catch (err) { console.warn('Persistência falhou:', err.code); }
        }

        const INITIAL_STATE = {
            user: null, isAdmin: false, currentScreen: 'home',
            events: [], types: [], locations: [], attendants: [],
            isMenuOpen: false, editingEventId: null, isViewAll: false,
            searchTerm: '', filterStartDate: '', filterEndDate: '',
            advancedFilter: { active: false, useGroupType: false, selectedRadio: 'type', valType: '', valSigla: '', useLoc: false, valLoc: '', useAtt: false, valAtt: '', useDate: false, dateStart: '', dateEnd: '' },
            tempAdvFilter: null, pickerTarget: null, selectedDate: null, viewDate: new Date(),
            editingRowId: null, isCreatingRow: false, tempName: '', tempSigla: '', managerSearchTerm: ''
        };

        const state = new Proxy(INITIAL_STATE, {
            set(target, property, value) {
                target[property] = value;
                if (!['tempName', 'tempSigla', 'managerSearchTerm', 'searchTerm'].includes(property)) { renderApp(); } 
                else { if (property === 'searchTerm') { renderHome(); window.renderIcons(); } if (property === 'managerSearchTerm') renderApp(); }
                return true;
            }
        });

        async function startApp() {
            await initPersistence();
            onAuthStateChanged(auth, (user) => { state.user = user ? { uid: user.uid, email: user.email } : null; state.isAdmin = user && user.uid === ADMIN_UID; renderApp(); });
            const collections = [{ name: "agenda", order: ["date", "time"], target: "events" }, { name: "types", order: ["name"], target: "types" }, { name: "locations", order: ["name"], target: "locations" }, { name: "attendants", order: ["name"], target: "attendants" }];
            collections.forEach(col => {
                let q = collection(db, col.name); col.order.forEach(field => q = query(q, orderBy(field)));
                onSnapshot(q, { includeMetadataChanges: true }, (s) => { state[col.target] = s.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderApp(); }, (e) => { console.error(e); renderApp(); });
            });

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                .then(reg => {
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => { if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) { window.location.reload(); }};
                    };
                })
                .catch(err => console.log('SW Registration Warning (pode ser ignorado em preview):', err));
            }
        }
        startApp();

        window.state = state;
        function formatDate(dateStr) { if (!dateStr) return ''; const parts = dateStr.split('-'); if (parts.length !== 3) return dateStr; return `${parts[2]}/${parts[1]}/${parts[0].slice(2)}`; }
        function isEventPast(date, time) { return new Date(`${date}T${time}`) < new Date(); }

        window.navigateTo = (screen) => { if (state.currentScreen === screen) { state.isMenuOpen = false; renderApp(); return; } history.pushState({ screen: screen }, '', ''); state.isMenuOpen = false; state.currentScreen = screen; state.editingRowId = null; state.isCreatingRow = false; state.tempName = ''; state.tempSigla = ''; state.managerSearchTerm = ''; renderApp(); };
        window.renderIcons = () => { if(window.lucide) lucide.createIcons(); }

        function getFilteredEvents() {
            if (state.advancedFilter.active) {
                const af = state.advancedFilter;
                return state.events.filter(e => {
                    let match = true;
                    if (af.useGroupType) { if (af.selectedRadio === 'type' && e.typeId !== af.valType) match = false; else if (af.selectedRadio === 'sigla' && e.typeId !== af.valSigla) match = false; }
                    if (af.useLoc && e.locationId !== af.valLoc) match = false;
                    if (af.useAtt && e.attendantId !== af.valAtt) match = false;
                    if (af.useDate) { const start = af.dateStart || '0000-00-00'; const end = af.dateEnd || '9999-12-31'; if (e.date < start || e.date > end) match = false; }
                    return match;
                });
            }
            const lowerTerm = state.searchTerm.toLowerCase();
            return state.events.filter(e => {
                const type = state.types.find(t => t.id === e.typeId); const loc = state.locations.find(l => l.id === e.locationId); const att = state.attendants.find(a => a.id === e.attendantId);
                const matchesSearch = !state.searchTerm || (type?.name.toLowerCase().includes(lowerTerm)) || (type?.sigla?.toLowerCase().includes(lowerTerm)) || (loc?.name.toLowerCase().includes(lowerTerm)) || (att?.name.toLowerCase().includes(lowerTerm));
                let matchesDate = true;
                if (state.selectedDate) matchesDate = e.date === state.selectedDate;
                else if (state.filterStartDate || state.filterEndDate) { const start = state.filterStartDate || '0000-00-00'; const end = state.filterEndDate || '9999-12-31'; matchesDate = e.date >= start && e.date <= end; }
                return matchesSearch && matchesDate;
            });
        }

        window.startOpenAgenda = () => { state.pickerTarget = null; state.viewDate = new Date(); openAgendaModal(); };
        window.resetAllFilters = () => { state.searchTerm = ''; state.selectedDate = null; state.filterStartDate = ''; state.filterEndDate = ''; state.advancedFilter.active = false; state.isViewAll = true; renderApp(); };
        window.startCreateEvent = () => { if (!state.isAdmin) return; state.editingEventId = null; navigateTo('event-form'); };
        
        window.openAgendaModal = () => {
            const year = state.viewDate.getFullYear(); const month = state.viewDate.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay();
            let calendarHtml = '';
            for (let i = 0; i < firstDay; i++) calendarHtml += `<div class="aspect-square"></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const eventsOnDay = state.events.filter(e => e.date === dateStr); const isSelected = state.selectedDate === dateStr; const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                let dotsHtml = eventsOnDay.slice(0, 4).map(() => `<span class="w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-orange-custom' : 'bg-navy'}"></span>`).join('');
                if (eventsOnDay.length > 4) dotsHtml += `<span class="text-[8px] leading-none ${isSelected ? 'text-orange-custom' : 'text-navy'}">+</span>`;
                calendarHtml += `<button onclick="toggleDateSelection('${dateStr}')" class="aspect-square flex flex-col items-center justify-start pt-1.5 rounded-lg border ${isSelected ? 'bg-navy text-white shadow-md border-navy scale-105 z-10' : 'hover:bg-slate-200/60 border-transparent'} ${isToday && !isSelected ? 'bg-blue-50/50 font-bold border-blue-200' : ''}"><span class="text-xs sm:text-sm leading-none mb-1">${day}</span><div class="flex gap-0.5 justify-center flex-wrap px-0.5 w-full">${dotsHtml}</div></button>`;
            }
            let title = 'Agenda'; if (state.pickerTarget) title = 'Selecione a Data';
            const html = `
                <div id="calendar-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 flex flex-col max-h-[90vh]">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-navy flex items-center gap-2"><i data-lucide="calendar" class="w-5 h-5"></i> ${title}</h3><button onclick="closeModal()" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button></div>
                    <div><div class="flex justify-between items-center mb-4 gap-2 bg-slate-50 p-2 rounded-lg"><button onclick="changeMonth(-1)" class="p-1.5 hover:bg-slate-200/50 rounded-full"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><div class="flex gap-2 items-center flex-1 justify-center"><select onchange="changeViewDate()" id="monthSelect" class="p-1 rounded bg-transparent font-bold text-navy text-center">${['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'].map((m, i) => `<option value="${i}" ${i === state.viewDate.getMonth() ? 'selected' : ''}>${m}</option>`).join('')}</select><select onchange="changeViewDate()" id="yearSelect" class="p-1 rounded bg-transparent font-bold text-navy text-center">${Array.from({length: 10}, (_, i) => new Date().getFullYear() - 5 + i).map(y => `<option value="${y}" ${y === state.viewDate.getFullYear() ? 'selected' : ''}>${y}</option>`).join('')}</select></div><button onclick="changeMonth(1)" class="p-1.5 hover:bg-slate-200/50 rounded-full"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs font-black text-slate-400 mb-2"><div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div></div><div class="grid grid-cols-7 gap-1 sm:gap-2 mb-2">${calendarHtml}</div></div>
                    ${!state.pickerTarget && state.selectedDate ? `<div class="border-t pt-3 mt-2 flex-1 min-h-0 flex flex-col"><div class="text-xs font-bold text-slate-500 uppercase mb-2">Eventos: ${formatDate(state.selectedDate)}</div><div class="flex flex-col gap-1 overflow-y-auto max-h-[180px] pr-1">${state.events.filter(e => e.date === state.selectedDate).map(e => `<div class="bg-slate-50 border border-slate-200 p-2 rounded flex items-center gap-2 text-xs"><span class="font-bold text-navy">${e.time}</span><span class="truncate font-medium text-slate-700 flex-1">${state.types.find(t => t.id === e.typeId)?.name || 'Evento'}</span></div>`).join('') || '<div class="text-center text-slate-400 text-xs italic">Nada agendado.</div>'}</div></div>` : ''}
                    ${!state.pickerTarget ? `<div class="mt-4 pt-3 border-t"><button onclick="closeModal(); renderApp()" class="w-full py-3 bg-navy text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2"><i data-lucide="list" class="w-4 h-4"></i> Ver Lista</button></div>` : ''}
                </div>`;
            window.showModal(html);
        };
        window.toggleDateSelection = (d) => { 
            if (state.pickerTarget) { 
                if (state.pickerTarget.startsWith('TEMP_')) {
                    const field = state.pickerTarget.replace('TEMP_', ''); if (field === 'adv_dateStart') state.tempAdvFilter.dateStart = d; if (field === 'adv_dateEnd') state.tempAdvFilter.dateEnd = d;
                    state.pickerTarget = null; if(window.openAdvancedFilterModal) window.openAdvancedFilterModal(true); return;
                }
                state[state.pickerTarget] = d; if (state.pickerTarget === 'filterStartDate' && state.filterEndDate && state.filterEndDate < d) state.filterEndDate = d; state.selectedDate = null; state.pickerTarget = null; state.isViewAll = false; closeModal(); renderApp(); return;
            }
            state.selectedDate = state.selectedDate === d ? null : d; state.filterStartDate = state.selectedDate || ''; state.filterEndDate = state.selectedDate || ''; if(document.getElementById('calendar-modal-content')) openAgendaModal(); else renderApp(); 
        };
        window.changeMonth = (d) => { state.viewDate = new Date(state.viewDate.getFullYear(), state.viewDate.getMonth() + d, 1); if(document.getElementById('calendar-modal-content')) openAgendaModal(); else renderApp(); };
        window.changeViewDate = () => { state.viewDate = new Date(parseInt(document.getElementById('yearSelect').value), parseInt(document.getElementById('monthSelect').value), 1); if(document.getElementById('calendar-modal-content')) openAgendaModal(); else renderApp(); };

        window.openAdvancedFilterModal = (restore = false) => {
             const src = restore && state.tempAdvFilter ? state.tempAdvFilter : state.advancedFilter;
             const typeOpts = `<option value="">Selecione...</option>` + state.types.map(t => `<option value="${t.id}" ${t.id === src.valType ? 'selected' : ''}>${t.name}</option>`).join('');
             const html = `<div id="advanced-filter-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-4 animate-in fade-in zoom-in"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-navy">Filtros</h3><button onclick="closeModal()"><i data-lucide="x"></i></button></div>
             <form id="advFilterForm" class="flex flex-col gap-4">
                 <div class="border p-3 rounded bg-slate-50"><div class="flex gap-2 mb-2"><input type="checkbox" id="adv_useGroupType" ${src.useGroupType?'checked':''}><label>Tipo/Sigla</label></div><select id="adv_valType" class="w-full p-2 border rounded">${typeOpts}</select></div>
                 <div class="flex gap-3"><button type="button" onclick="closeModal()" class="flex-1 py-2 bg-slate-100 rounded">Cancelar</button><button type="button" onclick="applyAdvancedFilter()" class="flex-1 py-2 bg-navy text-white rounded">Filtrar</button></div>
             </form></div>`;
             window.showModal(html);
        };
        window.applyAdvancedFilter = () => { state.advancedFilter.active = true; state.advancedFilter.useGroupType = document.getElementById('adv_useGroupType').checked; state.advancedFilter.valType = document.getElementById('adv_valType').value; state.searchTerm = ''; state.selectedDate = null; state.isViewAll = false; closeModal(); renderApp(); };

        window.renderApp = () => {
            if (document.getElementById('calendar-modal-content')) return; if (document.getElementById('advanced-filter-modal')) return;
            switch (state.currentScreen) {
                case 'home': renderHome(); break; case 'event-form': renderEventForm(); break; case 'types': renderGenericManager('Tipos', 'types', 'Tipo', true); break; case 'locations': renderGenericManager('Locais', 'locations', 'Local', false); break; case 'attendants': renderGenericManager('Atendentes', 'attendants', 'Atendente', false); break; case 'about': renderAbout(); break;
            }
            window.renderIcons();
        };

        function renderHome() {
            const appElement = document.getElementById('app'); let container = document.getElementById('home-container');
            if (!container) {
                appElement.innerHTML = ''; container = document.createElement('div'); container.id = 'home-container'; container.className = "flex flex-col h-full bg-slate-100 relative";
                container.innerHTML = `<div id="nav-menu-placeholder"></div><div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center flex-shrink-0"><button onclick="state.isMenuOpen = true; renderApp()" class="p-1"><i data-lucide="menu" class="w-7 h-7"></i></button><h1 class="text-lg font-bold uppercase">Eventos Adm Valente</h1><div class="w-8"></div></div>
                    <div class="flex flex-col flex-1 overflow-hidden p-4 gap-4 max-w-xl mx-auto w-full"><div class="flex flex-col gap-3 flex-shrink-0"><div class="relative"><div class="flex justify-between items-center mb-3"><div class="flex gap-2"><button onclick="startOpenAgenda()" class="flex items-center gap-1 px-3 py-1.5 bg-navy text-white text-xs font-bold rounded"><i data-lucide="calendar" class="w-3 h-3"></i> Agenda</button><button onclick="resetAllFilters()" class="flex items-center gap-1 px-3 py-1.5 bg-navy text-white text-xs font-bold rounded"><i data-lucide="list" class="w-3 h-3"></i> Ver Todos</button></div><button onclick="openPDFPreview()" class="flex items-center gap-1 px-3 py-1.5 bg-navy text-white text-xs font-bold rounded"><i data-lucide="file-text" class="w-3 h-3"></i> PDF</button></div><div class="flex gap-2 items-center"><div class="relative flex-1"><input id="homeSearch" type="text" placeholder="Pesquisar..." class="w-full pl-10 pr-3 py-2 text-sm border rounded-lg"><i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i></div><button onclick="openAdvancedFilterModal()" class="p-2 bg-white border rounded-lg"><i data-lucide="filter" class="w-4 h-4"></i></button></div></div>${state.advancedFilter.active ? `<div class="flex justify-between"><span class="text-xs font-bold text-navy">Filtros Ativos</span><button onclick="resetAllFilters()" class="text-xs text-red-600 font-bold">Limpar</button></div>` : ''}</div><div id="event-list-container" class="flex flex-col gap-2 flex-1 min-h-0"></div></div><div id="fab-container"></div>`;
                appElement.appendChild(container); document.getElementById('homeSearch').addEventListener('input', (e) => { state.searchTerm = e.target.value; if(e.target.value) { state.advancedFilter.active = false; state.isViewAll = false; renderApp(); }});
            }
            const homeSearch = document.getElementById('homeSearch'); if (document.activeElement !== homeSearch) homeSearch.value = state.searchTerm; document.getElementById('nav-menu-placeholder').innerHTML = renderNavMenu();
            document.getElementById('fab-container').innerHTML = state.isAdmin ? `<button onclick="startCreateEvent()" class="fixed bottom-6 right-6 w-14 h-14 bg-orange-custom text-white rounded-full shadow-xl flex items-center justify-center z-50"><i data-lucide="plus" class="w-7 h-7"></i></button>` : '';
            const filteredEvents = getFilteredEvents(); let listHeader = state.advancedFilter.active ? 'Filtro' : (state.selectedDate ? `Eventos: ${formatDate(state.selectedDate)}` : (state.isViewAll ? 'Todos' : 'Próximos'));
            document.getElementById('event-list-container').innerHTML = `<div class="flex justify-between items-end px-1"><label class="text-base font-bold text-navy">${listHeader}</label><span class="text-sm font-medium text-slate-500">${filteredEvents.length}</span></div><div class="flex-1 overflow-y-auto border bg-slate-50 rounded-xl shadow-md min-h-0">${filteredEvents.length === 0 ? `<div class="h-full flex items-center justify-center text-slate-400 p-4">Vazio</div>` : `<ul class="divide-y">${filteredEvents.map(e => { const type = state.types.find(t => t.id === e.typeId); const loc = state.locations.find(l => l.id === e.locationId); const att = state.attendants.find(a => a.id === e.attendantId); const isPast = isEventPast(e.date, e.time); return `<li onclick="${state.isAdmin ? `openEditEvent('${e.id}')` : ''}" class="p-3 border-b last:border-0 ${isPast ? 'bg-slate-50 opacity-70' : ''}"><div class="flex items-start gap-3"><div class="w-12 h-12 rounded-xl border flex items-center justify-center ${isPast ? 'bg-slate-100 text-slate-400' : 'bg-blue-50 text-navy'}"><i data-lucide="${isPast ? 'check-circle-2' : 'calendar-clock'}"></i></div><div class="flex-1"><div class="flex justify-between"><h3 class="font-bold text-navy truncate pr-2">${type?.name||'Evento'}</h3><span class="px-2 rounded text-xs font-bold ${isPast ? 'bg-slate-300' : 'bg-slate-500 text-white'}">${type?.sigla||'SIG'}</span></div><div class="text-sm text-slate-500">${formatDate(e.date)} | ${e.time}</div><div class="flex flex-col text-sm text-slate-600"><span>${loc?.name}</span><span>${att?.name}</span></div></div></div></li>`; }).join('')}</ul>`}</div>`;
        }

        function renderNavMenu() { if (!state.isMenuOpen) return ''; return `<div class="fixed inset-0 z-50"><div class="absolute inset-0 bg-slate-900/60" onclick="state.isMenuOpen = false; renderApp()"></div><div class="relative w-72 h-full bg-navy text-white flex flex-col shadow-2xl slide-in"><div class="p-6 border-b border-white/10 flex justify-between bg-[#002855]"><h2 class="text-xl font-bold">Menu</h2><button onclick="state.isMenuOpen = false; renderApp()"><i data-lucide="x"></i></button></div><nav class="flex-1 py-4 flex flex-col gap-1 overflow-y-auto">${[{id: 'home', icon: 'calendar', label: 'Início'}, {id: 'types', icon: 'tag', label: 'Tipos'}, {id: 'locations', icon: 'map-pin', label: 'Locais'}, {id: 'attendants', icon: 'users', label: 'Atendentes'}, {id: 'about', icon: 'info', label: 'Sobre'}].map(i => `<button onclick="navigateTo('${i.id}')" class="w-full flex items-center px-6 py-4 hover:bg-white/10 gap-3"><i data-lucide="${i.icon}" class="text-orange-custom"></i><span>${i.label}</span></button>`).join('')}</nav><div class="p-4 border-t border-white/10 bg-[#002244]">${state.user ? `<button onclick="handleLogout()" class="w-full flex justify-center gap-2 px-4 py-3 bg-red-600/20 text-red-200 rounded-lg">Sair</button>` : `<button onclick="showLoginModal()" class="w-full flex justify-center gap-2 px-4 py-3 bg-white/10 text-white rounded-lg">Login</button>`}</div></div></div>`; }
        window.openEditEvent = (id) => { state.editingEventId = id; navigateTo('event-form'); };
        window.handleLogout = async () => { await signOut(auth); state.isMenuOpen = false; };
        window.showLoginModal = () => { state.isMenuOpen = false; renderApp(); const t = document.getElementById('login-modal-template'); const c = document.getElementById('modal-container'); c.innerHTML = ''; c.appendChild(t.content.cloneNode(true)); c.classList.remove('hidden'); document.getElementById('login-form').onsubmit = async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); closeModal(); } catch (e) { document.getElementById('login-error').textContent = "Erro de credenciais."; document.getElementById('login-error').classList.remove('hidden'); }}; };
        window.closeModal = () => { document.getElementById('modal-container').classList.add('hidden'); document.getElementById('modal-container').innerHTML = ''; };
        window.showModal = (html) => { const c = document.getElementById('modal-container'); c.innerHTML = html; c.classList.remove('hidden'); window.renderIcons(); };
        window.openPDFPreview = () => { const evts = getFilteredEvents(); if (evts.length === 0) return alert("Sem dados."); const rows = evts.map(e => `<tr><td>${formatDate(e.date)}</td><td>${e.time}</td><td>${state.types.find(t=>t.id===e.typeId)?.name}</td></tr>`).join(''); window.showModal(`<div class="bg-white p-4 rounded w-full max-w-lg"><h3>PDF Preview</h3><table class="w-full text-sm text-left mt-2"><thead><tr><th>Data</th><th>Hora</th><th>Evento</th></tr></thead><tbody>${rows}</tbody></table><div class="mt-4 flex gap-2"><button onclick="closeModal()" class="flex-1 border p-2 rounded">Fechar</button><button onclick="confirmPDFDownload()" class="flex-1 bg-navy text-white p-2 rounded">Baixar</button></div></div>`); };
        window.confirmPDFDownload = () => { const evts = getFilteredEvents(); const doc = new window.jspdf.jsPDF(); const data = evts.map(e => [formatDate(e.date), e.time, state.types.find(t=>t.id===e.typeId)?.name, state.locations.find(l=>l.id===e.locationId)?.name]); doc.autoTable({ head: [['Data', 'Hora', 'Evento', 'Local']], body: data }); doc.save('agenda.pdf'); closeModal(); };

        function renderEventForm() {
            const appElement = document.getElementById('app'); appElement.innerHTML = ''; const isEditing = !!state.editingEventId; const event = isEditing ? state.events.find(e => e.id === state.editingEventId) : { date: new Date().toISOString().split('T')[0], time: '08:00', locationId: '', typeId: '', attendantId: '' };
            const div = document.createElement('div'); div.className = "flex flex-col h-screen bg-slate-100";
            div.innerHTML = `<div class="bg-navy text-white p-4 flex items-center gap-3"><button onclick="navigateTo('home')"><i data-lucide="arrow-left"></i></button><h1 class="font-bold uppercase">${isEditing ? 'Editar' : 'Novo'} Evento</h1></div><div class="p-4 flex flex-col gap-4 max-w-xl mx-auto w-full"><div class="bg-white p-4 rounded-lg shadow border border-slate-200 flex flex-col gap-3"><div class="grid grid-cols-2 gap-3"><input type="date" id="evtDate" class="p-2 border rounded" value="${event?.date||''}"><input type="time" id="evtTime" class="p-2 border rounded" value="${event?.time||''}"></div><select id="evtLoc" class="p-2 border rounded"><option value="">Local...</option>${state.locations.map(l=>`<option value="${l.id}" ${l.id===event?.locationId?'selected':''}>${l.name}</option>`).join('')}</select><select id="evtType" class="p-2 border rounded"><option value="">Tipo...</option>${state.types.map(t=>`<option value="${t.id}" ${t.id===event?.typeId?'selected':''}>${t.name}</option>`).join('')}</select><select id="evtAtt" class="p-2 border rounded"><option value="">Atendente...</option>${state.attendants.map(a=>`<option value="${a.id}" ${a.id===event?.attendantId?'selected':''}>${a.name}</option>`).join('')}</select>${!state.isAdmin ? '' : `<button onclick="saveEvent()" class="bg-navy text-white p-3 rounded font-bold mt-2">Salvar</button>`}${isEditing && state.isAdmin ? `<button onclick="deleteEvent()" class="text-red-600 p-2 font-bold text-sm">Excluir</button>` : ''}</div></div>`;
            appElement.appendChild(div);
        }
        window.saveEvent = async () => { const date = document.getElementById('evtDate').value; const time = document.getElementById('evtTime').value; const locationId = document.getElementById('evtLoc').value; const typeId = document.getElementById('evtType').value; const attendantId = document.getElementById('evtAtt').value; if (!date || !time || !locationId || !typeId || !attendantId) return alert('Preencha tudo.'); try { if (state.editingEventId) await updateDoc(doc(db, "agenda", state.editingEventId), { date, time, locationId, typeId, attendantId }); else await addDoc(collection(db, "agenda"), { date, time, locationId, typeId, attendantId }); state.editingEventId = null; navigateTo('home'); } catch(e) { alert('Erro ao salvar.'); }};
        window.deleteEvent = async () => { if(confirm('Excluir?')) { await deleteDoc(doc(db, "agenda", state.editingEventId)); state.editingEventId=null; navigateTo('home'); }};
        function renderAbout() { document.getElementById('app').innerHTML = `<div class="p-4"><button onclick="navigateTo('home')">Voltar</button><h1>Sobre</h1><p>Adm Valente v1.0</p></div>`; }
        function renderGenericManager(title, collectionKey, nameLabel, hasSigla) { const appElement = document.getElementById('app'); appElement.innerHTML = `<div class="flex flex-col h-screen bg-slate-100"><div class="bg-navy text-white p-4 flex items-center gap-3"><button onclick="navigateTo('home')"><i data-lucide="arrow-left"></i></button><h1 class="font-bold uppercase">${title}</h1></div><div class="p-4 flex-1 overflow-y-auto">${state.isAdmin ? `<button onclick="startCreateRow()" class="mb-4 bg-orange-custom text-white px-4 py-2 rounded font-bold">+ Adicionar</button>` : ''}${state.isCreatingRow ? renderInlineRow(null, nameLabel, hasSigla, true) : ''}<ul class="flex flex-col gap-2">${state[collectionKey].map(i => state.editingRowId === i.id ? renderInlineRow(i, nameLabel, hasSigla, false) : `<li class="bg-white p-3 rounded shadow flex justify-between items-center"><span>${i.name} ${hasSigla && i.sigla ? `(${i.sigla})` : ''}</span>${state.isAdmin ? `<div><button onclick="startEditRow('${i.id}')" class="text-blue-600 mr-2"><i data-lucide="pencil"></i></button><button onclick="requestDeleteRow('${i.id}', '${collectionKey}', '${nameLabel}')" class="text-red-600"><i data-lucide="trash-2"></i></button></div>` : ''}</li>`).join('')}</ul></div></div>`; }
        function renderInlineRow(item, lbl, sigla, isNew) { return `<div class="bg-blue-50 p-3 rounded mb-2 border border-blue-200"><input id="editNameInput" class="w-full p-2 mb-2 border rounded" placeholder="Nome" value="${isNew ? state.tempName : (state.tempName || item.name)}" oninput="state.tempName=this.value">${sigla ? `<input class="w-full p-2 mb-2 border rounded" placeholder="Sigla" value="${isNew ? state.tempSigla : (state.tempSigla || item.sigla)}" oninput="state.tempSigla=this.value">` : ''}<div class="flex gap-2"><button onclick="saveGenericRow('${isNew?'':item.id}', '${sigla}')" class="bg-green-600 text-white px-3 py-1 rounded">Salvar</button><button onclick="cancelGenericEdit()" class="bg-red-400 text-white px-3 py-1 rounded">Cancelar</button></div></div>`; }
        window.startCreateRow = () => { if (!state.isAdmin) return showLoginModal(); state.isCreatingRow = true; state.editingRowId = null; state.tempName = ''; state.tempSigla = ''; renderApp(); };
        window.startEditRow = (id) => { if (!state.isAdmin) return showLoginModal(); const k = getCollectionKeyByScreen(state.currentScreen); const i = state[k].find(x => x.id === id); state.isCreatingRow = false; state.editingRowId = id; state.tempName = i.name; state.tempSigla = i.sigla||''; renderApp(); };
        window.cancelGenericEdit = () => { state.isCreatingRow = false; state.editingRowId = null; state.tempName = ''; state.tempSigla = ''; renderApp(); };
        window.saveGenericRow = async (id, hasSigla) => { const k = getCollectionKeyByScreen(state.currentScreen); const data = { name: state.tempName }; if(hasSigla === 'true' || hasSigla === true) data.sigla = state.tempSigla; try { if(id) await updateDoc(doc(db, k, id), data); else await addDoc(collection(db, k), data); cancelGenericEdit(); } catch(e) { alert('Erro'); } };
        window.requestDeleteRow = async (id, k, n) => { if(confirm('Excluir?')) await deleteDoc(doc(db, k, id)); };
        window.getCollectionKeyByScreen = (s) => s === 'types' ? 'types' : (s === 'locations' ? 'locations' : 'attendants');
    </script>
</body>
</html>
