<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eventos Adm Valente</title>
    <meta name="description" content="Gerenciador de Agenda Administrativa">
    <meta name="theme-color" content="#003366">
    
    <!-- Bibliotecas Externas (CDNs) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    
    <!-- PDF & Image Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        html, body, * { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-navy { background-color: #003366; } .text-navy { color: #003366; } .border-navy { border-color: #003366; }
        .bg-orange-custom { background-color: #FF8C00; } .text-orange-custom { color: #FF8C00; } .border-orange-custom { border-color: #FF8C00; }
        input:focus, select:focus, textarea:focus { outline: none; }
        input:-webkit-autofill { -webkit-box-shadow: 0 0 0 30px white inset !important; }
        .disabled-area { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; border-width: 2px !important; }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            background-color: #f1f5f9;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #003366;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        .loading-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: #94a3b8;
        }

        #report-capture-area {
            width: 794px;
            min-height: 1123px;
            background: white;
            padding: 50px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transform-origin: top center;
        }

        #report-preview-scroll-wrapper {
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
            display: flex; flex-direction: column; align-items: center;
        }

        #scaling-container {
            width: 794px;
            display: flex; flex-direction: column; align-items: center;
        }

        .highlight-item {
            background-color: #fef3c7 !important;
            border-left: 4px solid #f59e0b !important;
        }

        /* Clock Picker Specific CSS */
        .clock-face { position: relative; width: 240px; height: 240px; border-radius: 50%; background: #f8fafc; border: 4px solid #e2e8f0; margin: 0 auto; }
        .clock-center { position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; background: #003366; border-radius: 50%; transform: translate(-50%, -50%); z-index: 10; }
        .clock-hand { position: absolute; bottom: 50%; left: 50%; width: 2px; background: #003366; transform-origin: bottom center; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s; z-index: 5; }
        .clock-hand::after { content: ''; position: absolute; top: -15px; left: -15px; width: 30px; height: 30px; border-radius: 50%; background: #003366; border: 2px solid #003366; box-sizing: border-box; z-index: 6; }
        .clock-number { position: absolute; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; cursor: pointer; border-radius: 50%; transition: all 0.2s; user-select: none; z-index: 15; transform: translate(-50%, -50%); color: #003366; }
        .clock-number:hover { background: #f1f5f9; }
        .clock-number.active { background: transparent; color: white; }
    </style>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">
    <meta name="theme-color" content="#003366">
</head>
<body class="h-screen w-full flex flex-col bg-slate-100">

    <!-- App Root -->
    <div id="app" class="flex-1 w-full h-full relative overflow-hidden flex flex-col">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <span class="loading-text">Carregando Agenda...</span>
        </div>
    </div>

    <!-- Modals Overlay -->
    <div id="modal-container" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm"></div>

    <!-- Template: Login Modal -->
    <template id="login-modal-template">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="p-5 border-b border-slate-100 bg-slate-50">
                <h3 class="font-bold text-lg text-navy">Área Administrativa</h3>
            </div>
            <form id="login-form" class="p-6 flex flex-col gap-4">
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">Email</label>
                    <input type="email" id="login-email" class="w-full p-3 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">Senha</label>
                    <input type="password" id="login-password" class="w-full p-3 border border-slate-300 rounded-lg" required>
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden font-medium"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="window.closeModal()" class="flex-1 py-3 rounded-lg bg-slate-100 font-bold">Cancelar</button>
                    <button type="submit" class="flex-1 py-3 rounded-lg bg-navy text-white font-bold">Entrar</button>
                </div>
            </form>
        </div>
    </template>

    <script type="module">
        /**
         * ==========================================
         * 1. FIREBASE CONFIGURATION & INITIALIZATION (MODULAR V9+)
         * ==========================================
         */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            initializeFirestore, 
            persistentLocalCache, 
            persistentMultipleTabManager, 
            collection, 
            onSnapshot, 
            doc, 
            addDoc, 
            updateDoc, 
            deleteDoc 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCmceNv1eBJLj7aWMcR7crvSVxonuzDVQo", 
            authDomain: "agendaadmvalente.firebaseapp.com", 
            projectId: "agendaadmvalente", 
            storageBucket: "agendaadmvalente.firebasestorage.app", 
            messagingSenderId: "810572581910", 
            appId: "1:810572581910:web:155a7e18f6c46f77faf937" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        const db = initializeFirestore(app, {
            localCache: persistentLocalCache({
                tabManager: persistentMultipleTabManager()
            })
        });

        const ADMIN_UID = "kRzVsk2nqNTyj79Lk4h6Fmhk7JP2";

        /**
         * ==========================================
         * 2. INDEXEDDB CACHE UTILS
         * ==========================================
         */
        const IDB_CONFIG = { name: 'AgendaValenteCache', version: 1, store: 'appData' };

        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(IDB_CONFIG.name, IDB_CONFIG.version);
                request.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(IDB_CONFIG.store)) db.createObjectStore(IDB_CONFIG.store);
                };
                request.onsuccess = e => resolve(e.target.result);
                request.onerror = e => reject(e.target.error);
            });
        }

        async function saveCache(key, val) {
            try {
                const db = await openDB();
                const tx = db.transaction(IDB_CONFIG.store, 'readwrite');
                tx.objectStore(IDB_CONFIG.store).put(JSON.parse(JSON.stringify(val)), key);
            } catch (e) { console.warn('Erro ao salvar no IDB:', e); }
        }

        async function loadCache(key) {
            try {
                const db = await openDB();
                return new Promise(resolve => {
                    const request = db.transaction(IDB_CONFIG.store).objectStore(IDB_CONFIG.store).get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => resolve(null);
                });
            } catch (e) { return null; }
        }

        /**
         * ==========================================
         * 3. STATE MANAGEMENT & UTILS
         * ==========================================
         */
        const defaultAdvancedFilter = {
            active: false,
            useStatus: false, statusVal: 'active',
            useGroupType: false, valType: '',
            useLoc: false, valLoc: '',
            useAtt: false, valAtt: '',
            useDate: false, dateStart: '', dateEnd: ''
        };

        const INITIAL_STATE = {
            user: null, isAdmin: false, currentScreen: 'home',
            events: [], types: [], locations: [], attendants: [],
            isMenuOpen: false, editingEventId: null, isViewAll: false,
            searchTerm: '', filterStartDate: '', filterEndDate: '',
            advancedFilter: defaultAdvancedFilter,
            fastFilter: { active: false, dateStart: '', dateEnd: '', label: '' },
            tempAdvFilter: null, pickerTarget: null, timePickerTarget: null, selectedDate: null, viewDate: new Date(),
            editingRowId: null, isCreatingRow: false, tempName: '', tempSigla: '', tempExtra: '', managerSearchTerm: '',
            formTempDate: '', formTempTime: '', formTempLoc: '', formTempType: '', formTempAtt: '',
            formOriginalValues: null,
            highlightedId: null, fastFilterLabel: '',
            holidays: [], holidaysFetchedYears: []
        };

        let renderTimer = null;
        function scheduleRender() {
            if (renderTimer) return;
            renderTimer = requestAnimationFrame(() => {
                renderApp();
                renderTimer = null;
            });
        }

        window.state = new Proxy(INITIAL_STATE, {
            set(target, property, value) {
                if (target[property] === value) return true;
                target[property] = value;
                if (typeof property === 'string') {
                    if (['events', 'types', 'locations', 'attendants'].includes(property)) saveCache(property, value);
                    const isSilent = ['tempName', 'tempSigla', 'tempExtra', 'managerSearchTerm', 'searchTerm', 'formTempDate', 'formTempTime', 'formTempLoc', 'formTempType', 'formTempAtt', 'formOriginalValues', 'highlightedId', 'fastFilterLabel', 'holidays', 'holidaysFetchedYears'].includes(property);
                    if (!isSilent) scheduleRender();
                    else { 
                        if (property === 'searchTerm') { 
                            if (value) {
                                target.advancedFilter.active = false;
                                target.fastFilter.active = false;
                                target.isViewAll = false;
                                target.selectedDate = null;
                                target.filterStartDate = '';
                                target.filterEndDate = '';
                            }
                            window.updateHomeList(); 
                        }
                        if (property === 'managerSearchTerm') scheduleRender(); 
                        if (property === 'highlightedId') scheduleRender();
                        if (['formTempDate', 'formTempTime', 'formTempLoc', 'formTempType', 'formTempAtt'].includes(property)) {
                             if (target.currentScreen === 'event-form') scheduleRender();
                        }
                    }
                }
                return true;
            }
        });

        const formatDate = (dateStr) => { if (!dateStr) return ''; const parts = dateStr.split('-'); if (parts.length !== 3) return dateStr; return `${parts[2]}/${parts[1]}/${parts[0].slice(2)}`; }
        const formatDateFull = (dateStr) => { if (!dateStr) return ''; const parts = dateStr.split('-'); if (parts.length !== 3) return dateStr; return `${parts[2]}/${parts[1]}/${parts[0]}`; }
        const isEventPast = (date, time) => { return new Date(`${date}T${time}`) < new Date(); }
        window.renderIcons = () => { if(window.lucide) window.lucide.createIcons(); }

        /**
         * ==========================================
         * 4. RENDERERS
         * ==========================================
         */
        function renderApp() {
            if (document.getElementById('calendar-modal-content')) return; 
            if (document.getElementById('advanced-filter-modal')) return;
            switch (window.state.currentScreen) {
                case 'home': renderHome(); break; 
                case 'event-form': renderEventForm(); break; 
                case 'types': renderGenericManager('Tipos de Eventos', 'types', 'Tipo', true); break; 
                case 'locations': renderGenericManager('Localidades', 'locations', 'Localidade', false); break; 
                case 'attendants': renderGenericManager('Atendentes', 'attendants', 'Atendente', false); break; 
                case 'about': renderAbout(); break;
            }
            window.renderIcons();
        }
        window.renderApp = renderApp;

        function renderHome() {
            const appElement = document.getElementById('app'); 
            let container = document.getElementById('home-container');
            if (!container && appElement) {
                appElement.innerHTML = ''; 
                container = document.createElement('div'); 
                container.id = 'home-container'; 
                container.className = "flex flex-col h-full bg-slate-100 relative";
                container.innerHTML = `
                    <div id="nav-menu-placeholder"></div>
                    <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center flex-shrink-0">
                        <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="menu" class="w-7 h-7"></i></button>
                        <h1 class="text-lg font-bold uppercase tracking-wide">Eventos Adm Valente</h1>
                        <button onclick="window.resetAllFilters()" class="p-1 hover:bg-white/10 rounded" title="Início"><i data-lucide="home" class="w-7 h-7"></i></button>
                    </div>
                    <div class="flex flex-col flex-1 overflow-hidden p-4 gap-4 max-w-xl mx-auto w-full overflow-y-auto">
                        <div class="flex gap-2 mb-3">
                            <button onclick="window.startOpenAgenda()" class="flex-1 flex items-center justify-center gap-1 h-10 bg-navy text-white text-[10px] font-bold rounded shadow"><i data-lucide="calendar" class="w-3 h-3"></i> Agenda</button>
                            <button onclick="window.resetAllFilters()" class="flex-1 flex items-center justify-center gap-1 h-10 bg-navy text-white text-[10px] font-bold rounded shadow"><i data-lucide="list" class="w-3 h-3"></i> Todos</button>
                            <button onclick="window.openFastFilterModal()" class="flex-1 flex items-center justify-center gap-1 h-10 bg-navy text-white text-[10px] font-bold rounded shadow"><i data-lucide="more-horizontal" class="w-3 h-3"></i> Mais</button>
                            <button onclick="window.openPDFPreview()" class="flex-1 flex items-center justify-center gap-1 h-10 bg-navy text-white text-[10px] font-bold rounded shadow"><i data-lucide="file-text" class="w-3 h-3"></i> Exportar</button>
                        </div>
                        <div class="flex gap-2 items-center">
                            <div class="relative flex-1">
                                <input id="homeSearch" type="text" placeholder="Pesq. evento, sigla, local ou atendente" class="w-full pl-10 pr-3 h-10 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-navy/20 shadow-sm">
                                <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                            </div>
                            <button onclick="window.openAdvancedFilterModal()" class="flex items-center justify-center w-10 h-10 bg-white border border-slate-300 rounded-lg shadow-sm text-navy hover:bg-slate-50">
                                <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div id="event-list-container" class="flex flex-col gap-2 flex-1 min-h-0"></div>
                    </div>
                    <div id="fab-container"></div>
                `;
                appElement.appendChild(container); 
                document.getElementById('homeSearch')?.addEventListener('input', (e) => { window.state.searchTerm = e.target.value; });
            }
            if (document.getElementById('homeSearch')) document.getElementById('homeSearch').value = window.state.searchTerm;
            const navPlaceholder = document.getElementById('nav-menu-placeholder'); 
            if(navPlaceholder) navPlaceholder.innerHTML = renderNavMenu();
            const fabContainer = document.getElementById('fab-container'); 
            if(fabContainer) fabContainer.innerHTML = window.state.isAdmin ? `<button onclick="window.startCreateEvent()" class="fixed bottom-6 right-6 w-14 h-14 bg-orange-custom text-white rounded-full shadow-xl flex items-center justify-center z-50 border border-white/20"><i data-lucide="plus" class="w-7 h-7"></i></button>` : '';
            window.updateHomeList();
        }

        window.updateHomeList = () => {
            const filteredEvents = getFilteredEvents(); 
            let listHeader = getFilterDescription();
            const listContainer = document.getElementById('event-list-container');
            if(listContainer) {
                listContainer.innerHTML = `
                    <div class="flex justify-between items-end px-1">
                        <label class="text-base font-bold text-navy flex-1 pr-2">${listHeader}</label>
                        <span class="text-sm font-medium text-slate-500 flex-shrink-0">${filteredEvents.length} registros</span>
                    </div>
                    <div class="flex-1 overflow-y-auto border border-slate-200 bg-slate-50 rounded-xl shadow-md min-h-0">
                        ${filteredEvents.length === 0 ? `<div class="h-full flex items-center justify-center text-slate-400 p-4">Nenhum evento encontrado.</div>` : 
                        `<ul class="divide-y divide-slate-200/50">
                            ${filteredEvents.map((e) => { 
                                const type = window.state.types.find(t => t.id === e.typeId); 
                                const loc = window.state.locations.find(l => l.id === e.locationId); 
                                const att = window.state.attendants.find(a => a.id === e.attendantId); 
                                const isPast = isEventPast(e.date, e.time); 
                                return `
                                    <li onclick="${window.state.isAdmin ? `window.openEditEvent('${e.id}')` : ''}" class="p-3 border-b border-slate-200/50 last:border-0 ${window.state.isAdmin ? 'cursor-pointer hover:bg-slate-100' : ''} ${isPast ? 'bg-slate-50 opacity-75 grayscale-[0.5]' : ''}">
                                        <div class="flex items-start gap-3">
                                            <div class="w-12 h-12 rounded-xl border flex items-center justify-center flex-shrink-0 ${isPast ? 'bg-slate-100 text-slate-400' : 'bg-blue-50 text-navy border-blue-100'}">
                                                <i data-lucide="${isPast ? 'check-circle-2' : 'calendar-clock'}" class="w-6 h-6"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex justify-between items-start mb-0.5">
                                                    <h3 class="font-bold text-navy pr-2 leading-tight">${type?.name||'Evento'}</h3>
                                                    <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-slate-500 text-white">${type?.sigla||'SIG'}</span>
                                                </div>
                                                <div class="text-sm font-medium text-slate-500 mb-1">${formatDate(e.date)} | ${e.time}</div>
                                                <div class="flex flex-col text-sm text-slate-600 gap-0.5">
                                                    <div class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> <span>${loc?.name || '-'}</span></div>
                                                    <div class="flex items-center gap-1"><i data-lucide="users" class="w-3 h-3"></i> <span>${att?.name || '-'}</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>`; 
                            }).join('')}
                        </ul>`}
                    </div>`;
            }
            window.renderIcons();
        }

        /**
         * ==========================================
         * 5. RELATÓRIOS & PREVIEW
         * ==========================================
         */
        window.adjustReportScale = () => {
            const wrapper = document.getElementById('report-preview-scroll-wrapper');
            const area = document.getElementById('report-capture-area');
            if (!wrapper || !area) return;
            const padding = 32; 
            const availableWidth = wrapper.clientWidth - padding;
            const designWidth = 794; 
            const scaleFactor = Math.min(1, availableWidth / designWidth);
            area.style.transform = `scale(${scaleFactor})`;
            const scaledHeight = area.offsetHeight * scaleFactor;
            const sc = document.getElementById('scaling-container');
            if (sc) sc.style.height = `${scaledHeight}px`;
        };

        window.openPDFPreview = () => {
            const events = getFilteredEvents();
            const rowsHtml = events.map((e) => {
                const type = window.state.types.find(t => t.id === e.typeId);
                const loc = window.state.locations.find(l => l.id === e.locationId);
                const att = window.state.attendants.find(a => a.id === e.attendantId);
                return `
                    <tr class="border-b border-slate-300">
                        <td class="p-2 border-r border-slate-300 text-xs text-navy whitespace-nowrap">${formatDateFull(e.date)}</td>
                        <td class="p-2 border-r border-slate-300 text-xs text-slate-600">${e.time}</td>
                        <td class="p-2 border-r border-slate-300 text-xs text-navy">${type?.name || '-'}</td>
                        <td class="p-2 border-r border-slate-300 text-xs text-slate-600">${loc?.name || '-'}</td>
                        <td class="p-2 text-xs text-slate-600">${att?.name || '-'}</td>
                    </tr>`;
            }).join('');

            window.showModal(`
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col h-[95vh] overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center flex-shrink-0">
                        <h3 class="font-bold text-lg text-navy flex items-center gap-2"><i data-lucide="file-text"></i> Visualizar Lista</h3>
                        <button onclick="window.closeModal()"><i data-lucide="x" class="w-6 h-6 text-slate-400"></i></button>
                    </div>
                    <div id="report-preview-scroll-wrapper" class="flex-1 p-4 bg-slate-200/50">
                        <div id="scaling-container">
                            <div id="report-capture-area">
                                <div class="text-center mb-6">
                                    <h2 class="text-lg font-black text-navy uppercase tracking-tight">Lista de Eventos - Adm Valente</h2>
                                </div>
                                <div class="flex-1">
                                    <table class="w-full text-left border-collapse border border-slate-300">
                                        <thead>
                                            <tr class="bg-navy text-white">
                                                <th class="p-2 border border-slate-300 text-[10px] font-black uppercase tracking-widest">Data</th>
                                                <th class="p-2 border border-slate-300 text-[10px] font-black uppercase tracking-widest">Hora</th>
                                                <th class="p-2 border border-slate-300 text-[10px] font-black uppercase tracking-widest">Evento</th>
                                                <th class="p-2 border border-slate-300 text-[10px] font-black uppercase tracking-widest">Local</th>
                                                <th class="p-2 border border-slate-300 text-[10px] font-black uppercase tracking-widest">Atendente</th>
                                            </tr>
                                        </thead>
                                        <tbody>${rowsHtml || '<tr><td colspan="5" class="p-10 text-center text-slate-300 italic text-xs">Sem registros.</td></tr>'}</tbody>
                                    </table>
                                </div>
                                <div class="mt-4 text-right text-[10px] text-slate-400 font-black border-t border-navy/10 pt-2 uppercase tracking-widest">Total: ${events.length}</div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-white border-t flex flex-col gap-3 shrink-0">
                        <div class="flex gap-3">
                            <button onclick="window.confirmPNGDownload()" class="flex-1 px-4 py-3 bg-navy text-white rounded-lg font-black uppercase text-xs tracking-widest shadow flex items-center justify-center gap-2 hover:bg-navy-dark"><i data-lucide="image"></i> PNG</button>
                            <button onclick="window.confirmPDFDownload()" class="flex-1 px-4 py-3 bg-navy text-white rounded-lg font-black uppercase text-xs tracking-widest shadow flex items-center justify-center gap-2 hover:bg-navy-dark"><i data-lucide="download"></i> PDF</button>
                        </div>
                        <button onclick="window.closeModal()" class="w-full py-3 bg-slate-100 text-slate-500 rounded-lg font-black uppercase text-xs tracking-widest hover:bg-slate-200">Fechar</button>
                    </div>
                </div>
            `);
            setTimeout(window.adjustReportScale, 50);
            window.addEventListener('resize', window.adjustReportScale);
        };

        window.confirmPDFDownload = () => {
            const doc = new window.jspdf.jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            doc.setFontSize(12);
            doc.setTextColor(0, 51, 102); 
            doc.text("Lista de Eventos - Adm Valente", pageWidth / 2, 15, { align: 'center' }); 
            const events = getFilteredEvents();
            const tableData = events.map(e => {
                const type = window.state.types.find(t => t.id === e.typeId);
                const loc = window.state.locations.find(l => l.id === e.locationId);
                const att = window.state.attendants.find(a => a.id === e.attendantId);
                return [ formatDateFull(e.date), e.time, type?.name || '-', loc?.name || '-', att?.name || '-' ];
            });
            doc.autoTable({
                startY: 25,
                head: [['DATA', 'HORA', 'EVENTO', 'LOCAL', 'ATENDENTE']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [0, 51, 102], textColor: 255, fontStyle: 'bold', fontSize: 10 },
                styles: { fontSize: 8, cellPadding: 2 },
                alternateRowStyles: { fillColor: [241, 245, 249] }
            });
            doc.save(`agenda-valente-${new Date().toISOString().split('T')[0]}.pdf`);
            window.closeModal();
        };

        window.confirmPNGDownload = () => {
            const element = document.getElementById('report-capture-area');
            if (!element) return;
            window.removeEventListener('resize', window.adjustReportScale);
            window.html2canvas(element, {
                scale: 4,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 794,
                windowWidth: 794,
                onclone: (clonedDoc) => {
                    const clonedArea = clonedDoc.getElementById('report-capture-area');
                    if (clonedArea) {
                        clonedArea.style.transform = 'scale(1)';
                        clonedArea.style.boxShadow = 'none';
                        clonedArea.style.margin = '0';
                    }
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `agenda-valente-${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                window.closeModal();
            });
        };

        /**
         * ==========================================
         * 6. GESTORES GENÉRICOS (TIPOS, LOCAIS, ETC)
         * ==========================================
         */
        function renderGenericManager(title, collectionKey, nameLabel, hasSigla) { 
            const appElement = document.getElementById('app'); 
            if(!appElement) return;

            let container = document.getElementById('manager-container');
            if (container && container.dataset.screen !== window.state.currentScreen) {
                appElement.innerHTML = ''; 
                container = null;
            }

            if (!container) {
                appElement.innerHTML = '';
                container = document.createElement('div');
                container.id = 'manager-container';
                container.dataset.screen = window.state.currentScreen;
                container.className = "flex flex-col h-screen bg-slate-100";
                
                container.innerHTML = `
                    <div class="bg-navy text-white p-4 flex justify-between items-center shadow-lg z-10 flex-shrink-0">
                        <div class="flex items-center gap-3">
                            <button onclick="window.navigateTo('home')" class="hover:bg-white/10 p-1 rounded-full"><i data-lucide="arrow-left"></i></button>
                            <h1 class="font-bold uppercase tracking-wide">${title}</h1>
                        </div>
                        <button onclick="window.resetAllFilters(); window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded" title="Início"><i data-lucide="home" class="w-7 h-7"></i></button>
                    </div>
                    <div class="p-4 flex-1 overflow-hidden flex flex-col gap-4 max-w-xl mx-auto w-full">
                        <div class="relative shrink-0">
                            <input id="managerSearch" type="text" placeholder="Buscar..." class="w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-navy/20" value="${window.state.managerSearchTerm}">
                            <i data-lucide="search" class="absolute left-3 top-3.5 text-slate-400 w-5 h-5"></i>
                        </div>
                        <div class="flex justify-end items-center px-1 -mb-3">
                            <div id="manager-count" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest"></div>
                        </div>
                        <div id="manager-list-container" class="flex-1 overflow-y-auto border border-slate-200 bg-slate-50 rounded-xl shadow-md min-h-0">
                        </div>
                        ${window.state.isAdmin ? `
                        <button onclick="window.startCreateRow()" class="w-full py-3 bg-navy text-white rounded-lg font-bold shadow-lg shadow-blue-900/20 hover:bg-navy-dark flex items-center justify-center gap-2 shrink-0">
                            <i data-lucide="plus" class="w-4 h-4"></i> Adicionar
                        </button>` : ''}
                    </div>
                `;
                appElement.appendChild(container);
                const searchInput = document.getElementById('managerSearch');
                searchInput.addEventListener('input', (e) => {
                    window.state.managerSearchTerm = e.target.value;
                    window.state.highlightedId = null;
                    window.updateGenericList(collectionKey);
                });
                searchInput.addEventListener('click', () => { window.state.highlightedId = null; });
                
                // Coloca o cursor no campo de busca ao abrir a tela de gerenciamento
                setTimeout(() => searchInput.focus(), 50);
            }
            window.updateGenericList(collectionKey);
        }

        window.updateGenericList = (collectionKey) => {
            const listContainer = document.getElementById('manager-list-container');
            const countContainer = document.getElementById('manager-count');
            if (!listContainer) return;

            const colList = (window.state[collectionKey] || []).sort((a, b) => a.name.localeCompare(b.name));
            const hasSigla = collectionKey === 'types';
            let iconName = 'folder';
            if (collectionKey === 'types') iconName = 'tag';
            if (collectionKey === 'locations') iconName = 'map-pin';
            if (collectionKey === 'attendants') iconName = 'user';

            const term = window.state.managerSearchTerm.toLowerCase();
            const filtered = colList.filter((i) => {
                const fields = [i.name, i.sigla, i.Cidade, i.Ministério];
                return fields.some(f => f && f.toLowerCase().includes(term));
            });
            
            if (countContainer) {
                countContainer.textContent = `${filtered.length} registros`;
            }

            listContainer.innerHTML = `
                <ul class="divide-y divide-slate-200/50">
                    ${filtered.map((i) => {
                        const isHighlighted = window.state.highlightedId === i.id;
                        let extraInfo = '';
                        if (collectionKey === 'locations' && i.Cidade) extraInfo = `<span class="text-[10px] block font-medium text-slate-500 uppercase tracking-tighter">${i.Cidade}</span>`;
                        if (collectionKey === 'attendants' && i.Ministério) extraInfo = `<span class="text-[10px] block font-medium text-slate-500 uppercase tracking-tighter">${i.Ministério}</span>`;

                        return `
                            <li id="item-${i.id}" onclick="window.state.highlightedId = null" class="p-3 border-b border-slate-200/50 last:border-0 bg-white hover:bg-slate-50 ${isHighlighted ? 'highlight-item' : ''}">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-blue-50 text-navy flex items-center justify-center border border-blue-100 shrink-0">
                                        <i data-lucide="${iconName}" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between gap-2">
                                            <div class="flex flex-col min-w-0">
                                                <span class="font-bold text-navy text-sm sm:text-base break-words">${i.name}</span>
                                                ${extraInfo}
                                            </div>
                                            ${hasSigla && i.sigla ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-200 text-slate-600 shrink-0 border border-slate-300">${i.sigla}</span>` : ''}
                                        </div>
                                    </div>
                                    ${window.state.isAdmin ? `
                                    <div class="flex gap-1 shrink-0">
                                        <button onclick="event.stopPropagation(); window.startEditRow('${i.id}')" class="p-2 text-blue-600 hover:bg-blue-100 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                        <button onclick="event.stopPropagation(); window.requestDeleteRow('${i.id}', '${collectionKey}', '${i.name}')" class="p-2 text-red-600 hover:bg-red-100 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>` : ''}
                                </div>
                            </li>
                        `;
                    }).join('')}
                </ul>
                ${filtered.length === 0 ? `<div class="p-8 text-center text-slate-400 italic">Nenhum registro encontrado.</div>` : ''}
            `;
            if (window.state.highlightedId) {
                const el = document.getElementById(`item-${window.state.highlightedId}`);
                if (el) el.scrollIntoView({ block: 'center' });
            }
            window.renderIcons();
        }

        function renderInlineRow(item, lbl, sigla, isNew) { 
            let extraFieldHtml = '';
            if (window.state.currentScreen === 'locations') {
                extraFieldHtml = `<div class="mb-4"><label class="text-xs font-bold text-navy uppercase block mb-1">Cidade <span class="text-red-500">*</span></label><input id="editExtraInput" class="w-full p-3 border border-slate-300 rounded bg-slate-50 focus:ring-2 focus:ring-blue-200 outline-none" placeholder="Informe a Cidade" value="${window.state.tempExtra || ''}" oninput="window.state.tempExtra=this.value; this.classList.remove('input-error')"></div>`;
            } else if (window.state.currentScreen === 'attendants') {
                extraFieldHtml = `<div class="mb-4"><label class="text-xs font-bold text-navy uppercase block mb-1">Ministério <span class="text-red-500">*</span></label><input id="editExtraInput" class="w-full p-3 border border-slate-300 rounded bg-slate-50 focus:ring-2 focus:ring-blue-200 outline-none" placeholder="Informe o Ministério" value="${window.state.tempExtra || ''}" oninput="window.state.tempExtra=this.value; this.classList.remove('input-error')"></div>`;
            }

            return `<div id="inline-edit-row" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm overflow-hidden border border-slate-200"><h3 class="font-bold text-lg text-navy mb-4 border-b pb-2">${isNew ? 'Adicionar' : 'Editar'} ${lbl}</h3><div class="mb-4"><label class="text-xs font-bold text-navy uppercase block mb-1">${lbl} <span class="text-red-500">*</span></label><input id="editNameInput" class="w-full p-3 border border-slate-300 rounded bg-slate-50 focus:ring-2 focus:ring-blue-200 outline-none" placeholder="Nome" value="${isNew ? window.state.tempName : (window.state.tempName || item.name)}" oninput="window.state.tempName=this.value; this.classList.remove('input-error')"></div>${sigla ? `<div class="mb-5"><label class="text-xs font-bold text-navy uppercase block mb-1">Sigla <span class="text-red-500">*</span></label><input id="editSiglaInput" class="w-full p-3 border border-slate-300 rounded bg-slate-50 uppercase focus:ring-2 focus:ring-blue-200 outline-none" placeholder="SIGLA" maxlength="5" value="${isNew ? window.state.tempSigla : (window.state.tempSigla || item.sigla)}" oninput="window.state.tempSigla=this.value.toUpperCase(); this.classList.remove('input-error')"></div>` : extraFieldHtml}<div class="flex gap-3 pt-2"><button onclick="window.cancelGenericEdit()" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded font-bold hover:bg-slate-200">Cancelar</button><button onclick="window.saveGenericRow('${isNew?'':item.id}', ${sigla})" class="flex-1 bg-navy text-white py-3 rounded font-bold shadow-lg hover:bg-navy-dark">Salvar</button></div></div>`; 
        }

        /**
         * ==========================================
         * 7. FORMULÁRIO DE EVENTO
         * ==========================================
         */
        function renderEventForm() {
            const appElement = document.getElementById('app'); 
            if (!appElement) return;
            appElement.innerHTML = ''; 
            const isEditing = !!window.state.editingEventId; 
            const event = isEditing ? window.state.events.find(e => e.id === window.state.editingEventId) : null;
            if (isEditing && !event) { window.navigateTo('home', false); return; }
            
            const dateVal = window.state.formTempDate;
            const timeVal = window.state.formTempTime;
            const locVal = window.state.formTempLoc;
            const typeVal = window.state.formTempType;
            const attendantId = window.state.formTempAtt;

            const dateDisplay = dateVal ? formatDateFull(dateVal) : 'dd/mm/aaaa';
            const timeDisplay = (timeVal && timeVal !== 'hh:mm') ? timeVal : 'hh:mm';
            
            const selectedLoc = window.state.locations.find(l => l.id === locVal);
            const selectedType = window.state.types.find(t => t.id === typeVal);
            const selectedAtt = window.state.attendants.find(a => a.id === attendantId);

            let isModified = false;
            if (isEditing && window.state.formOriginalValues) {
                const orig = window.state.formOriginalValues;
                isModified = dateVal !== orig.date || timeVal !== orig.time || locVal !== orig.locationId || typeVal !== orig.typeId || (attendantId || '') !== (orig.attendantId || '');
            }

            const div = document.createElement('div'); 
            div.className = "flex flex-col h-screen bg-slate-100"; 
            div.id = "event-form-container";
            div.innerHTML = `
                <div class="bg-navy text-white p-4 flex justify-between items-center shadow-lg z-10">
                    <div class="flex items-center gap-3">
                        <button onclick="window.navigateTo('home')" class="hover:bg-white/10 p-1 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <h1 class="font-bold uppercase tracking-wide">${isEditing ? 'Editar' : 'Novo'} Evento</h1>
                    </div>
                    <button onclick="window.resetAllFilters(); window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded" title="Início"><i data-lucide="home" class="w-7 h-7"></i></button>
                </div>
                <div class="p-4 flex flex-col gap-4 max-w-xl mx-auto w-full overflow-y-auto">
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200 flex flex-col gap-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">Data <span class="text-red-500">*</span></label>
                                <button type="button" id="btnDate" onclick="this.classList.remove('input-error'); window.openFormDate()" class="w-full p-3 border border-slate-300 rounded-lg text-left text-slate-800 bg-white flex items-center gap-2">
                                    <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i> ${dateDisplay}
                                </button>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">Hora <span class="text-red-500">*</span></label>
                                <button type="button" id="btnTime" onclick="this.classList.remove('input-error'); window.openTimePickerModal('evtTime')" class="w-full p-3 border border-slate-300 rounded-lg text-left text-slate-800 bg-white flex items-center gap-2">
                                    <i data-lucide="clock" class="w-4 h-4 text-slate-400"></i> <span id="evtTimeDisplay">${timeDisplay}</span>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Local <span class="text-red-500">*</span></label>
                            <button type="button" id="btnLoc" onclick="this.classList.remove('input-error'); window.openSelectPicker('locations', 'Localidade', 'formTempLoc')" class="w-full p-3 border border-slate-300 rounded-lg text-left text-slate-800 bg-white flex items-center justify-between">
                                <span>${selectedLoc?.name || 'Selecione...'}</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Tipo de Evento <span class="text-red-500">*</span></label>
                            <button type="button" id="btnType" onclick="this.classList.remove('input-error'); window.openSelectPicker('types', 'Tipo de Evento', 'formTempType')" class="w-full p-3 border border-slate-300 rounded-lg text-left text-slate-800 bg-white flex items-center justify-between">
                                <span>${selectedType?.name || 'Selecione...'}</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Atendente <span class="text-xs font-normal text-slate-400">(Opcional)</span></label>
                            <button type="button" onclick="window.openSelectPicker('attendants', 'Atendente', 'formTempAtt')" class="w-full p-3 border border-slate-300 rounded-lg text-left text-slate-800 bg-white flex items-center justify-between">
                                <span>${selectedAtt?.name || 'Selecione...'}</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                            </button>
                        </div>
                        <div class="pt-4 flex flex-col gap-3 border-t mt-2">
                            ${!isEditing ? `
                                <button type="button" onclick="window.saveEvent()" class="w-full py-3 bg-navy text-white rounded-lg font-bold shadow-lg shadow-blue-900/20 hover:bg-navy-dark flex items-center justify-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Salvar Evento</button>
                            ` : (isModified ? `
                                <button type="button" onclick="window.saveEvent()" class="w-full py-3 bg-navy text-white rounded-lg font-bold shadow-lg shadow-blue-900/20 hover:bg-navy-dark flex items-center justify-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Salvar Evento</button>
                            ` : `
                                <button type="button" onclick="window.deleteEvent()" class="w-full py-3 border border-red-200 text-red-600 bg-red-50 rounded-lg font-bold hover:bg-red-100 flex items-center justify-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> Excluir Evento</button>
                            `)}
                            <button type="button" onclick="window.navigateTo('home')" class="w-full py-3 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 flex items-center justify-center gap-2">Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            appElement.appendChild(div);
            window.renderIcons();
        }

        /**
         * ==========================================
         * 8. NAVEGAÇÃO E MODAIS GERAIS
         * ==========================================
         */
        window.navigateTo = (screen, push = true) => { 
            if (window.state.currentScreen === screen) { 
                window.state.isMenuOpen = false; 
                return; 
            } 
            if (push) history.pushState({ screen: screen }, '', ''); 
            window.state.isMenuOpen = false; 
            window.state.currentScreen = screen; 
            window.state.highlightedId = null;
            ['home-container', 'manager-container', 'event-form-container'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.remove();
            });
        };
        window.openMenu = () => { window.state.isMenuOpen = true; };
        window.closeMenu = () => { window.state.isMenuOpen = false; };
        window.closeModal = () => { 
            window.removeEventListener('resize', window.adjustReportScale);
            const c = document.getElementById('modal-container'); 
            c.classList.add('hidden'); c.innerHTML = ''; 
        };
        window.showModal = (html) => { const c = document.getElementById('modal-container'); c.innerHTML = html; c.classList.remove('hidden'); window.renderIcons(); };
        window.handleLogout = async () => { await signOut(auth); window.state.isMenuOpen = false; };
        window.showLoginModal = () => { 
            window.state.isMenuOpen = false; 
            const t = document.getElementById('login-modal-template'); 
            const c = document.getElementById('modal-container'); 
            if (c && t) { 
                c.innerHTML = ''; c.appendChild(t.content.cloneNode(true)); c.classList.remove('hidden'); 
                const form = document.getElementById('login-form'); 
                if (form) {
                    form.onsubmit = async (e) => { 
                        e.preventDefault(); 
                        try { 
                            const email = document.getElementById('login-email').value;
                            const password = document.getElementById('login-password').value;
                            await signInWithEmailAndPassword(auth, email, password); window.closeModal(); 
                        } catch (e) { 
                            const errEl = document.getElementById('login-error'); 
                            if(errEl) { errEl.textContent = "Erro de credenciais."; errEl.classList.remove('hidden'); } 
                        }
                    }; 
                }
            } 
        };
        window.showConfirmationModal = (text, onConfirm) => {
            window.showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6"><h3 class="text-lg font-bold text-navy mb-2 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i> Confirmação</h3><p class="text-slate-600 mb-6 font-medium">${text}</p><div class="flex gap-3"><button onclick="window.closeModal()" class="flex-1 py-3 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200">Não</button><button id="confirm-action-btn" class="flex-1 py-3 bg-red-600 text-white rounded-lg font-bold shadow-lg hover:bg-red-700">Sim, Excluir</button></div></div>`);
            const btn = document.getElementById('confirm-action-btn');
            if (btn) btn.onclick = () => { onConfirm(); window.closeModal(); };
        };

        /**
         * ==========================================
         * 9. LOGICA DE NEGÓCIO (SALVAR, FILTRAR, EXCLUIR)
         * ==========================================
         */

        window.openSelectPicker = (collectionKey, title, targetStateKey, isFilter = false) => {
            const items = [...window.state[collectionKey]].sort((a, b) => a.name.localeCompare(b.name));
            const currentId = isFilter ? window.state.tempAdvFilter[targetStateKey] : window.state[targetStateKey];
            const closeHandler = isFilter ? 'window.openAdvancedFilterModal(true)' : 'window.closeModal()';

            window.showModal(`
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col max-h-[80vh] overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center flex-shrink-0">
                        <h3 class="font-bold text-navy flex items-center gap-2"><i data-lucide="list"></i> Selecionar ${title}</h3>
                        <button onclick="${closeHandler}"><i data-lucide="x" class="w-6 h-6 text-slate-400"></i></button>
                    </div>
                    <div class="p-2 border-b bg-white">
                        <div class="relative">
                            <input type="text" id="pickerSearch" placeholder="Filtrar..." class="w-full pl-9 pr-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-navy/20">
                            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                        </div>
                    </div>
                    <div id="picker-list" class="flex-1 overflow-y-auto p-2">
                        ${items.map(item => `
                            <button onclick="window.confirmSelectPicker('${targetStateKey}', '${item.id}', ${isFilter})" 
                                    class="w-full text-left p-3 rounded-lg mb-1 flex items-center justify-between ${currentId === item.id ? 'bg-blue-50 text-navy font-bold border border-blue-100' : 'hover:bg-slate-50 text-slate-600'}">
                                <span>${item.name} ${item.sigla ? `<span class="text-[10px] bg-slate-200 px-1 rounded ml-1 font-bold">${item.sigla}</span>` : ''}</span>
                                ${currentId === item.id ? '<i data-lucide="check" class="w-4 h-4 text-navy"></i>' : ''}
                            </button>
                        `).join('')}
                        ${!isFilter && targetStateKey === 'formTempAtt' ? `
                            <button onclick="window.confirmSelectPicker('${targetStateKey}', '', false)" class="w-full text-left p-3 rounded-lg mb-1 text-slate-400 italic hover:bg-slate-50">Nenhum (Limpar)</button>
                        ` : ''}
                        ${isFilter ? `<button onclick="window.confirmSelectPicker('${targetStateKey}', '', true)" class="w-full text-left p-3 rounded-lg mb-1 text-slate-400 italic hover:bg-slate-50">Todos (Limpar)</button>` : ''}
                    </div>
                </div>
                `);

            const sInput = document.getElementById('pickerSearch');
            sInput.oninput = (e) => {
                const val = e.target.value.toLowerCase();
                document.querySelectorAll('#picker-list button').forEach(btn => {
                    const text = btn.innerText.toLowerCase();
                    btn.classList.toggle('hidden', !text.includes(val));
                });
            };
            
            setTimeout(() => sInput.focus(), 50);
        };

        window.confirmSelectPicker = (key, id, isFilter) => {
            if (isFilter) {
                window.updateAdvFilterState(key, id);
                window.openAdvancedFilterModal(true);
            } else {
                window.state[key] = id;
                window.closeModal();
            }
        };

        window.saveEvent = async () => { 
            const btnDate = document.getElementById('btnDate');
            const btnTime = document.getElementById('btnTime');
            const btnLoc = document.getElementById('btnLoc');
            const btnType = document.getElementById('btnType');
            
            const date = window.state.formTempDate;
            const time = window.state.formTempTime;
            const locationId = window.state.formTempLoc;
            const typeId = window.state.formTempType;
            const attendantId = window.state.formTempAtt;
            
            [btnDate, btnTime, btnLoc, btnType].forEach(el => el?.classList.remove('input-error'));
            
            let hasValidationError = false;
            if (!date) { btnDate?.classList.add('input-error'); hasValidationError = true; }
            if (!time || time === 'hh:mm') { btnTime?.classList.add('input-error'); hasValidationError = true; }
            if (!locationId) { btnLoc?.classList.add('input-error'); hasValidationError = true; }
            if (!typeId) { btnType?.classList.add('input-error'); hasValidationError = true; }

            if (hasValidationError) {
                alert("Por favor, preencha todos os campos obrigatórios realçados.");
                return;
            }

            const duplicate = window.state.events.find(ev => 
                ev.id !== window.state.editingEventId && ev.date === date && ev.time === time && ev.locationId === locationId && ev.typeId === typeId && ev.attendantId === attendantId
            );
            if (duplicate) {
                window.showDuplicateWarning("Já existe um evento idêntico agendado para este horário e local.", () => {
                    window.resetAllFilters();
                    window.state.selectedDate = duplicate.date;
                    window.navigateTo('home');
                }, () => { window.closeModal(); });
                return;
            }

            try { 
                const payload = { date, time, locationId, typeId, attendantId };
                if (window.state.editingEventId) await updateDoc(doc(db, "agenda", window.state.editingEventId), payload);
                else await addDoc(collection(db, "agenda"), payload);
                window.state.editingEventId = null; window.state.formOriginalValues = null; window.resetAllFilters(); window.navigateTo('home'); 
            } catch(e) { alert('Erro ao salvar.'); }
        };

        window.deleteEvent = () => {
            const id = window.state.editingEventId;
            if (!id) return;
            window.showConfirmationModal("Deseja realmente excluir este evento?", async () => {
                try {
                    await deleteDoc(doc(db, "agenda", id));
                    window.state.editingEventId = null;
                    window.state.formOriginalValues = null;
                    window.navigateTo('home');
                } catch (e) {
                    alert("Erro ao excluir the evento.");
                }
            });
        };

        window.saveGenericRow = async (id, hasSigla) => {
            const nameInput = document.getElementById('editNameInput');
            const siglaInput = document.getElementById('editSiglaInput');
            const extraInput = document.getElementById('editExtraInput');
            
            const name = window.state.tempName.trim();
            const sigla = window.state.tempSigla.trim();
            const extra = (window.state.tempExtra || '').trim();
            
            let hasValidationError = false;
            if (nameInput) nameInput.classList.remove('input-error');
            if (siglaInput) siglaInput.classList.remove('input-error');
            if (extraInput) extraInput.classList.remove('input-error');

            if (!name) { 
                if(nameInput) nameInput.classList.add('input-error'); 
                hasValidationError = true; 
            }
            if (hasSigla && !sigla) { 
                if(siglaInput) siglaInput.classList.add('input-error'); 
                hasValidationError = true; 
            }
            const collKey = window.getCollectionKeyByScreen(window.state.currentScreen);
            if ((collKey === 'locations' || collKey === 'attendants') && !extra) {
                if(extraInput) extraInput.classList.add('input-error');
                hasValidationError = true;
            }

            if (hasValidationError) return;
            
            const items = window.state[collKey];

            const duplicate = items.find(i => {
                if (i.id === id) return false;
                const nameMatch = i.name.toLowerCase() === name.toLowerCase();
                const siglaMatch = hasSigla && i.sigla && i.sigla.toLowerCase() === sigla.toLowerCase();
                return nameMatch || siglaMatch;
            });

            if (duplicate) {
                const isNameDup = duplicate.name.toLowerCase() === name.toLowerCase();
                const msg = isNameDup ? `Já existe um registro com o nome "${name}".` : `A sigla "${sigla}" já está em uso por "${duplicate.name}".`;
                
                window.showDuplicateWarning(msg, () => {
                    window.state.managerSearchTerm = '';
                    window.state.highlightedId = duplicate.id;
                }, () => {
                    const titleMap = { types: 'Tipo de Evento', locations: 'Localidade', attendants: 'Atendente' };
                    const isNew = !id;
                    const currentItem = isNew ? null : items.find(i => i.id === id);
                    window.showModal(renderInlineRow(currentItem, titleMap[collKey], hasSigla, isNew));
                });
                return;
            }

            const payload = { name };
            if (hasSigla) payload.sigla = sigla.toUpperCase();
            if (collKey === 'locations') payload.Cidade = extra;
            if (collKey === 'attendants') payload.Ministério = extra;
            
            try {
                if (id) await updateDoc(doc(db, collKey, id), payload);
                else await addDoc(collection(db, collKey), payload);
                window.cancelGenericEdit();
            } catch (err) { alert("Erro ao salvar: " + err.message); }
        };

        window.requestDeleteRow = async (id, collName, name) => {
            window.showConfirmationModal(`Deseja realmente excluir "${name}"?`, async () => {
                try { await deleteDoc(doc(db, collName, id)); } catch (e) { alert("Erro ao excluir."); }
            });
        };
        window.getCollectionKeyByScreen = (s) => (s === 'types' ? 'types' : s === 'locations' ? 'locations' : s === 'attendants' ? 'attendants' : '');
        window.startCreateRow = () => { 
            window.state.highlightedId = null;
            window.state.isCreatingRow = true; window.state.editingRowId = null; 
            window.state.tempName = ''; window.state.tempSigla = ''; window.state.tempExtra = '';
            const titleMap = { types: 'Tipo de Evento', locations: 'Localidade', attendants: 'Atendente' };
            window.showModal(renderInlineRow(null, titleMap[window.getCollectionKeyByScreen(window.state.currentScreen)], window.state.currentScreen === 'types', true));
        };
        window.startEditRow = (id) => {
            window.state.highlightedId = null;
            const key = window.getCollectionKeyByScreen(window.state.currentScreen);
            const item = window.state[key].find(i => i.id === id);
            if(item) { 
                window.state.isCreatingRow = false; window.state.editingRowId = id; 
                window.state.tempName = item.name; 
                window.state.tempSigla = item.sigla || '';
                window.state.tempExtra = (item.Cidade || item.Ministério || '');
                const titleMap = { types: 'Tipo de Evento', locations: 'Localidade', attendants: 'Atendente' };
                window.showModal(renderInlineRow(item, titleMap[key], window.state.currentScreen === 'types', false));
            }
        };
        window.cancelGenericEdit = () => { 
            window.state.isCreatingRow = false; window.state.editingRowId = null; 
            window.state.tempExtra = '';
            window.closeModal(); 
        };

        /**
         * ==========================================
         * 10. AGENDA & FILTROS AVANÇADOS
         * ==========================================
         */
        window.startOpenAgenda = () => { window.state.pickerTarget = null; window.state.viewDate = new Date(); window.fetchHolidays(window.state.viewDate.getFullYear()); window.openAgendaModal(); };
        window.resetAllFilters = () => { 
            window.state.searchTerm = ''; window.state.selectedDate = null; window.state.filterStartDate = ''; window.state.filterEndDate = ''; window.state.fastFilterLabel = ''; window.state.advancedFilter = { ...defaultAdvancedFilter, active: false }; 
            window.state.fastFilter = { active: false, dateStart: '', dateEnd: '', label: '' };
            window.state.isViewAll = true; 
        };
        window.openEditEvent = (id) => { 
            const e = window.state.events.find(ev => ev.id === id); 
            if(e) { 
                window.state.editingEventId = id; 
                window.state.formTempDate = e.date; 
                window.state.formTempTime = e.time; 
                window.state.formTempLoc = e.locationId;
                window.state.formTempType = e.typeId;
                window.state.formTempAtt = e.attendantId || '';
                window.state.formOriginalValues = JSON.parse(JSON.stringify(e));
                window.navigateTo('event-form'); 
            } 
        };

        window.openMonthYearPicker = (type) => {
            const isMonth = type === 'month';
            const title = isMonth ? 'Selecionar Mês' : 'Selecionar Ano';
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const years = Array.from({length: 15}, (_, i) => new Date().getFullYear() - 5 + i);
            const items = isMonth ? monthNames.map((m, i) => ({ id: i, name: m })) : years.map(y => ({ id: y, name: String(y) }));
            const currentVal = isMonth ? window.state.viewDate.getMonth() : window.state.viewDate.getFullYear();

            window.showModal(`
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col max-h-[80vh] overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center flex-shrink-0">
                        <h3 class="font-bold text-navy flex items-center gap-2"><i data-lucide="list"></i> ${title}</h3>
                        <button onclick="window.openAgendaModal()"><i data-lucide="x" class="w-6 h-6 text-slate-400"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2">
                        ${items.map(item => `
                            <button onclick="window.confirmMonthYearSelect('${type}', ${item.id})" 
                                    class="w-full text-left p-4 rounded-lg mb-1 flex items-center justify-between ${currentVal === item.id ? 'bg-blue-50 text-navy font-bold border border-blue-100' : 'hover:bg-slate-50 text-slate-600'}">
                                <span>${item.name}</span>
                                ${currentVal === item.id ? '<i data-lucide="check" class="w-4 h-4 text-navy"></i>' : ''}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `);
            window.renderIcons();
        };

        window.confirmMonthYearSelect = (type, val) => {
            const currentY = window.state.viewDate.getFullYear();
            const currentM = window.state.viewDate.getMonth();
            if (type === 'month') window.state.viewDate = new Date(currentY, val, 1);
            else window.state.viewDate = new Date(val, currentM, 1);
            window.fetchHolidays(window.state.viewDate.getFullYear());
            window.openAgendaModal();
        };

        window.openAgendaModal = () => {
            const year = window.state.viewDate.getFullYear(); const month = window.state.viewDate.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay();
            let calendarHtml = '';
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            for (let i = 0; i < firstDay; i++) calendarHtml += `<div class="aspect-square"></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const currentDate = new Date(year, month, day);
                const isSunday = currentDate.getDay() === 0;
                const holiday = window.state.holidays?.find(h => h.date === dateStr);
                const isHoliday = !!holiday;
                const eventsOnDay = window.state.events.filter(e => e.date === dateStr); const isSelected = (window.state.selectedDate === dateStr) || (window.state.tempAdvFilter && (window.state.tempAdvFilter.dateStart === dateStr || window.state.tempAdvFilter.dateEnd === dateStr)); const isToday = new Date().toDateString() === currentDate.toDateString();
                let dotsHtml = '';
                if (!window.state.pickerTarget) dotsHtml = eventsOnDay.slice(0, 4).map(() => `<span class="w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-orange-custom' : 'bg-navy'}"></span>`).join('');
                calendarHtml += `<button onclick="window.toggleDateSelection('${dateStr}')" class="aspect-square flex flex-col items-center justify-start pt-1.5 rounded-lg border ${isSelected ? 'bg-navy text-white shadow-md border-navy z-10' : 'hover:bg-slate-200/60 border-transparent'} ${isToday && !isSelected ? 'bg-blue-50/50 font-bold border-blue-200' : ''} ${(isSunday || isHoliday) && !isSelected ? 'text-red-600 font-bold' : ''}"><span class="text-xs sm:text-sm leading-none mb-1">${day}</span><div class="flex gap-0.5 justify-center flex-wrap px-0.5 w-full">${dotsHtml}</div></button>`;
            }
            const holidayForDay = window.state.holidays?.find(h => h.date === window.state.selectedDate);
            const dayEvents = window.state.events.filter(e => e.date === window.state.selectedDate).sort((a, b) => a.time.localeCompare(b.time));
            const closeHandler = (window.state.pickerTarget && window.state.pickerTarget.startsWith('TEMP_')) ? 'window.openAdvancedFilterModal(true)' : 'window.closeModal()';

            window.showModal(`<div id="calendar-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-navy flex items-center gap-2"><i data-lucide="calendar" class="w-5 h-5"></i> Calendário</h3><button onclick="${closeHandler}" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="overflow-y-auto flex-1"><div class="flex justify-between items-center mb-4 gap-2 bg-slate-50 p-2 rounded-lg"><button onclick="window.changeMonth(-1)" class="p-1.5 hover:bg-slate-200/50 rounded-full"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><div class="flex gap-4 items-center flex-1 justify-center"><span onclick="window.openMonthYearPicker('month')" class="cursor-pointer bg-slate-50 font-black text-navy text-xs uppercase px-2 py-1">${monthNames[month]}</span><span onclick="window.openMonthYearPicker('year')" class="cursor-pointer bg-slate-50 font-black text-navy text-xs px-2 py-1">${year}</span></div><button onclick="window.changeMonth(1)" class="p-1.5 hover:bg-slate-200/50 rounded-full"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs font-black text-slate-400 mb-2"><div class="text-red-500">D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div></div><div class="grid grid-cols-7 gap-1 sm:gap-2 mb-2">${calendarHtml}</div> ${!window.state.pickerTarget && window.state.selectedDate ? `<div class="border-t pt-3 mt-2 flex-1 min-h-0 flex flex-col"><div class="text-xs font-bold text-slate-500 uppercase mb-2">Eventos: ${formatDate(window.state.selectedDate)}</div>${holidayForDay ? `<div class="mb-2 p-1.5 bg-red-50 border border-red-100 rounded text-red-600 text-[10px] font-black uppercase tracking-tight flex items-center gap-1 shadow-sm"><i data-lucide="info" class="w-3 h-3"></i> Feriado: ${holidayForDay.name}</div>` : ''}<div class="flex flex-col overflow-y-auto max-h-[220px] border border-slate-200 rounded-lg overflow-hidden">${dayEvents.map(e => { 
                const type = window.state.types.find(t => t.id === e.typeId); 
                const loc = window.state.locations.find(l => l.id === e.locationId);
                const siglaHtml = type?.sigla ? `<span class="px-1.5 py-0.5 rounded bg-navy text-white text-[9px] font-black uppercase shrink-0">${type.sigla}</span>` : ''; 
                return `
                <div class="bg-white border-b border-slate-100 p-2 flex flex-col gap-0.5 last:border-b-0 hover:bg-slate-50 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="font-black text-navy text-[9px] shrink-0">${e.time}</span>
                            <span class="font-bold text-slate-800 text-[10px] uppercase tracking-tighter">${type?.name || 'Evento'}</span>
                        </div>
                        ${siglaHtml}
                    </div>
                    <div class="text-[9px] text-slate-500 flex items-center gap-1 font-medium">
                        <i data-lucide="map-pin" class="w-2.5 h-2.5 text-slate-400 shrink-0"></i>
                        <span class="uppercase tracking-tighter">${loc?.name || '-'}</span>
                    </div>
                </div>`; 
            }).join('') || '<div class="text-center text-slate-400 text-xs italic py-4">Nada agendado para este dia.</div>'}</div></div>` : ''}</div> ${!window.state.pickerTarget ? `<div class="mt-4 pt-3 border-t"><button onclick="window.closeModal(); window.navigateTo('home'); window.renderApp();" class="w-full py-3 bg-navy text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-navy-dark"><i data-lucide="list" class="w-4 h-4"></i> Ver Lista</button></div>` : ''}</div>`);
            window.renderIcons();
        };
        window.toggleDateSelection = (d) => { 
            if (window.state.pickerTarget) { 
                if (window.state.pickerTarget.startsWith('TEMP_')) {
                    const field = window.state.pickerTarget.replace('TEMP_', ''); 
                    if (!window.state.tempAdvFilter) window.state.tempAdvFilter = { ...window.state.advancedFilter };
                    if (field === 'adv_dateStart') window.state.tempAdvFilter.dateStart = d; 
                    if (field === 'adv_dateEnd') window.state.tempAdvFilter.dateEnd = d;
                    window.state.pickerTarget = null; window.openAdvancedFilterModal(true); return;
                }
                if (window.state.pickerTarget === 'evtDate') window.state.formTempDate = d;
                window.state.pickerTarget = null; window.closeModal(); return;
            }
            window.state.selectedDate = window.state.selectedDate === d ? null : d;
            if(window.state.selectedDate) { window.state.advancedFilter = { ...window.state.advancedFilter, active: false }; window.state.fastFilter.active = false; window.state.searchTerm = ''; }
            window.openAgendaModal(); 
        };
        window.changeMonth = (d) => { window.state.selectedDate = null; const newDate = new Date(window.state.viewDate.getFullYear(), window.state.viewDate.getMonth() + d, 1); window.state.viewDate = newDate; window.fetchHolidays(newDate.getFullYear()); window.openAgendaModal(); };
        window.changeViewDate = () => { window.state.selectedDate = null; const y = parseInt(document.getElementById('yearSelect').value); const m = parseInt(document.getElementById('monthSelect').value); window.state.viewDate = new Date(y, m, 1); window.fetchHolidays(y); window.openAgendaModal(); };

        window.openTimePickerModal = (target) => {
            window.state.timePickerTarget = target;
            window.tempIsSelectingHours = true;
            let currentVal = window.state.formTempTime || '08:00';
            if (currentVal === 'hh:mm') currentVal = '08:00';
            window.tempTimeH = currentVal.split(':')[0]; 
            window.tempTimeM = currentVal.split(':')[1];
            window.renderClockModal();
        };

        window.renderClockModal = () => {
            const isH = window.tempIsSelectingHours;
            const title = isH ? 'Selecione a Hora' : 'Selecione os Minutos';
            
            const outerHours = [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            const innerHours = [0, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];
            const minutes = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55];
            
            const selectedH = parseInt(window.tempTimeH);
            const selectedM = parseInt(window.tempTimeM);
            
            const hourIndex = isH ? (selectedH >= 13 || selectedH === 0 ? innerHours.indexOf(selectedH) : outerHours.indexOf(selectedH)) : -1;
            const rotation = isH ? (hourIndex * 30) : (selectedM * 6);
            
            let handHeight = '90px'; 
            if (isH && (selectedH >= 13 || selectedH === 0)) handHeight = '60px'; 

            window.showModal(`
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-4 flex flex-col items-center">
                    <div class="w-full flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-navy flex items-center gap-2"><i data-lucide="clock" class="w-5 h-5"></i> ${title}</h3>
                        <button onclick="window.closeModal()" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-8 bg-slate-50 px-6 py-3 rounded-2xl border border-slate-200 shadow-inner">
                        <button onclick="window.tempIsSelectingHours=true; window.renderClockModal()" class="text-4xl font-black ${isH ? 'text-navy scale-110' : 'text-slate-400 hover:text-slate-600'} transition-all">${window.tempTimeH}</button>
                        <span class="text-4xl font-black text-slate-300">:</span>
                        <button onclick="window.tempIsSelectingHours=false; window.renderClockModal()" class="text-4xl font-black ${!isH ? 'text-navy scale-110' : 'text-slate-400 hover:text-slate-600'} transition-all">${window.tempTimeM}</button>
                    </div>

                    <div class="clock-face mb-8">
                        <div class="clock-center"></div>
                        <div class="clock-hand" style="height: ${handHeight}; transform: translateX(-50%) rotate(${rotation}deg)"></div>
                        ${isH ? `
                            ${outerHours.map((v, i) => {
                                const angle = i * 30;
                                const x = 50 + 90 * Math.sin(angle * Math.PI / 180) / (240 / 100);
                                const y = 50 - 90 * Math.cos(angle * Math.PI / 180) / (240 / 100);
                                return `<div onclick="window.selectClockVal(${v})" class="clock-number font-bold ${selectedH === v ? 'active' : ''}" style="left: ${x}%; top: ${y}%; font-size: 13px;">${v}</div>`;
                            }).join('')}
                            ${innerHours.map((v, i) => {
                                const angle = i * 30;
                                const x = 50 + 58 * Math.sin(angle * Math.PI / 180) / (240 / 100);
                                const y = 50 - 58 * Math.cos(angle * Math.PI / 180) / (240 / 100);
                                return `<div onclick="window.selectClockVal(${v})" class="clock-number font-bold ${selectedH === v ? 'active' : ''}" style="left: ${x}%; top: ${y}%;">${v === 0 ? '00' : v}</div>`;
                            }).join('')}
                        ` : `
                            ${minutes.map((v, i) => {
                                const angle = v * 6;
                                const x = 50 + 90 * Math.sin(angle * Math.PI / 180) / (240 / 100);
                                const y = 50 - 90 * Math.cos(angle * Math.PI / 180) / (240 / 100);
                                return `<div onclick="window.selectClockVal(${v})" class="clock-number font-bold ${selectedM === v ? 'active' : ''}" style="left: ${x}%; top: ${y}%">${String(v).padStart(2, '0')}</div>`;
                            }).join('')}
                        `}
                    </div>

                    <div class="w-full flex gap-3 mt-2">
                        <button onclick="window.closeModal()" class="flex-1 py-3 bg-slate-100 text-slate-700 rounded-lg font-bold">Cancelar</button>
                        <button onclick="window.confirmTimeSelection()" class="flex-1 py-3 bg-navy text-white rounded-lg font-bold shadow-lg">Confirmar</button>
                    </div>
                </div>
            `);
            window.renderIcons();
        };

        window.selectClockVal = (v) => {
            if (window.tempIsSelectingHours) {
                window.tempTimeH = String(v).padStart(2, '0');
                window.tempIsSelectingHours = false; 
            } else {
                window.tempTimeM = String(v).padStart(2, '0');
            }
            window.renderClockModal();
        };

        window.confirmTimeSelection = () => { window.state.formTempTime = `${window.tempTimeH}:${window.tempTimeM}`; window.closeModal(); };

        window.openFastFilterModal = () => {
            window.showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden"><div class="p-4 border-b bg-navy text-white flex justify-between items-center"><h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="filter"></i> Eventos para</h3><button onclick="window.closeModal()"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="p-6 bg-slate-50 flex flex-col gap-3">${['Hoje', 'Essa Semana', 'Esse Mês', 'Esse Ano'].map((l, i) => `<label class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-100"><input type="radio" name="fastFilterRange" value="${['hoje','semana','mes','ano'][i]}" ${i===0?'checked':''} class="w-4 h-4 text-navy"><span class="font-bold text-navy">${l}</span></label>`).join('')}</div><div class="p-4 border-t bg-white flex gap-3"><button onclick="window.closeModal()" class="flex-1 py-3 bg-slate-100 text-slate-700 rounded-lg font-bold">Cancelar</button><button onclick="window.applyFastFilter()" class="flex-1 py-3 bg-navy text-white rounded-lg font-bold shadow-lg">Filtrar</button></div></div>`);
        };

        window.applyFastFilter = () => {
            const selected = document.querySelector('input[name="fastFilterRange"]:checked')?.value;
            const now = new Date(); 
            let start, end, label;

            window.state.searchTerm = ''; 
            window.state.selectedDate = null;
            window.state.advancedFilter = { ...defaultAdvancedFilter, active: false };

            if (selected === 'hoje') { 
                const day = now.toISOString().split('T')[0]; 
                start = day; end = day; 
                label = "Eventos para Hoje";
            }
            else if (selected === 'semana') { 
                const d1 = new Date(now); 
                d1.setDate(now.getDate() - now.getDay()); 
                start = d1.toISOString().split('T')[0]; 
                const d2 = new Date(d1); 
                d2.setDate(d1.getDate() + 6); 
                end = d2.toISOString().split('T')[0];
                label = "Eventos para essa Semana";
            }
            else if (selected === 'mes') { 
                start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0]; 
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
                label = "Eventos para esse Mês";
            }
            else if (selected === 'ano') { 
                start = `${now.getFullYear()}-01-01`; 
                end = `${now.getFullYear()}-12-31`;
                label = "Eventos para esse Ano";
            }
            
            window.state.fastFilterLabel = label;
            window.state.fastFilter = { active: true, dateStart: start, dateEnd: end, label: label };
            window.closeModal(); 
            window.updateHomeList();
        };

        window.openAdvancedFilterModal = (restore = false, validationErrors = []) => {
            if (!restore) window.state.tempAdvFilter = { ...window.state.advancedFilter };
            const src = window.state.tempAdvFilter;
            
            const selLoc = window.state.locations.find(l => l.id === src.valLoc);
            const selAtt = window.state.attendants.find(a => a.id === src.valAtt);
            const selType = window.state.types.find(t => t.id === src.valType);
            
            const dsDisp = src.dateStart ? formatDateFull(src.dateStart) : 'Selecione...'; 
            const deDisp = src.dateEnd ? formatDateFull(src.dateEnd) : 'Selecione...';

            window.showModal(`<div id="advanced-filter-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-0 overflow-hidden flex flex-col max-h-[90vh]"><div class="p-3 border-b border-slate-100 flex justify-between items-center bg-navy text-white"><h3 class="font-bold text-base flex items-center gap-2"><i data-lucide="filter" class="w-4 h-4"></i> Informe os dados para Filtrar</h3><button onclick="window.closeModal()"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-3 overflow-y-auto flex-1 flex flex-col gap-2 bg-slate-50"><div class="bg-white p-2 rounded shadow-sm border border-slate-200"><div class="flex items-center justify-between mb-1"><label class="flex items-center gap-2 font-bold text-navy text-xs uppercase cursor-pointer"><input type="checkbox" ${src.useStatus?'checked':''} onchange="window.updateAdvFilterState('useStatus', this.checked); window.openAdvancedFilterModal(true)"> Eventos</label><div class="flex gap-3 ${!src.useStatus?'opacity-50 pointer-events-none':''}"> <label class="text-xs font-medium"><input type="radio" name="adv_st" value="active" ${src.statusVal==='active'?'checked':''} onchange="window.updateAdvFilterState('statusVal', 'active')"> Ativos</label> <label class="text-xs font-medium"><input type="radio" name="adv_st" value="inactive" ${src.statusVal==='inactive'?'checked':''} onchange="window.updateAdvFilterState('statusVal', 'inactive')"> Inativos</label></div></div></div><div class="bg-white p-2 rounded border"><label class="flex items-center gap-2 font-bold text-navy text-xs uppercase mb-1 cursor-pointer"><input type="checkbox" ${src.useGroupType?'checked':''} onchange="window.updateAdvFilterState('useGroupType', this.checked); window.openAdvancedFilterModal(true)"> Tipo de Evento/Sigla</label><button type="button" onclick="window.openSelectPicker('types', 'Tipo de Evento', 'valType', true)" class="w-full p-1.5 border rounded text-xs bg-white text-left flex justify-between items-center ${!src.useGroupType?'opacity-50 pointer-events-none':''} ${validationErrors.includes('type') ? 'input-error' : ''}"><span>${selType?.name || 'Selecione...'}</span><i data-lucide="chevron-down" class="w-3 h-3 text-slate-400"></i></button></div><div class="flex flex-col gap-2"><div class="bg-white p-2 rounded border"><label class="flex items-center gap-2 font-bold text-navy text-xs uppercase mb-1"><input type="checkbox" ${src.useLoc?'checked':''} onchange="window.updateAdvFilterState('useLoc', this.checked); window.openAdvancedFilterModal(true)"> Localidade</label><button type="button" onclick="window.openSelectPicker('locations', 'Local', 'valLoc', true)" class="w-full p-1.5 border rounded text-xs bg-white text-left flex justify-between items-center ${!src.useLoc?'opacity-50 pointer-events-none':''} ${validationErrors.includes('loc') ? 'input-error' : ''}"><span>${selLoc?.name || 'Selecione...'}</span><i data-lucide="chevron-down" class="w-3 h-3 text-slate-400"></i></button></div><div class="bg-white p-2 rounded border"><label class="flex items-center gap-2 font-bold text-navy text-xs uppercase mb-1"><input type="checkbox" ${src.useAtt?'checked':''} onchange="window.updateAdvFilterState('useAtt', this.checked); window.openAdvancedFilterModal(true)"> Atendente</label><button type="button" onclick="window.openSelectPicker('attendants', 'Atendente', 'valAtt', true)" class="w-full p-1.5 border rounded text-xs bg-white text-left flex justify-between items-center ${!src.useAtt?'opacity-50 pointer-events-none':''} ${validationErrors.includes('att') ? 'input-error' : ''}"><span>${selAtt?.name || 'Selecione...'}</span><i data-lucide="chevron-down" class="w-3 h-3 text-slate-400"></i></button></div></div><div class="bg-white p-2 rounded border"><label class="flex items-center gap-2 font-bold text-navy text-xs uppercase mb-2 cursor-pointer"><input type="checkbox" ${src.useDate?'checked':''} onchange="window.updateAdvFilterState('useDate', this.checked); window.openAdvancedFilterModal(true)"> Período</label><div class="grid grid-cols-2 gap-2 ${!src.useDate?'opacity-50 pointer-events-none':''}"><button onclick="window.openFilterDate('adv_dateStart')" class="p-1.5 border rounded text-xs bg-white text-left ${validationErrors.includes('dateStart') ? 'input-error' : ''}">${dsDisp}</button><button onclick="window.openFilterDate('adv_dateEnd')" class="p-1.5 border rounded text-xs bg-white text-left ${validationErrors.includes('dateEnd') ? 'input-error' : ''}">${deDisp}</button></div></div></div><div class="p-3 bg-white border-t flex flex-col gap-2"> <div class="flex gap-3"> <button onclick="window.clearAdvancedFilters()" class="flex-1 py-2 border border-red-200 text-red-600 bg-red-50 rounded font-bold text-sm flex items-center justify-center gap-2 hover:bg-red-100"><i data-lucide="trash-2" class="w-4 h-4"></i> Limpar</button> <button onclick="window.applyAdvancedFilter()" class="flex-1 py-2 bg-navy text-white rounded font-bold text-sm shadow flex items-center justify-center gap-2 hover:bg-navy-dark"><i data-lucide="filter" class="w-4 h-4"></i> Filtrar</button> </div> <button onclick="window.closeModal()" class="w-full py-2 bg-slate-100 text-slate-600 rounded font-bold text-sm">Voltar</button></div></div>`);
        };
        window.updateAdvFilterState = (f, v) => { if (!window.state.tempAdvFilter) window.state.tempAdvFilter = { ...window.state.advancedFilter }; window.state.tempAdvFilter[f] = v; };
        
        window.clearAdvancedFilters = () => {
            window.state.tempAdvFilter = { ...defaultAdvancedFilter };
            window.openAdvancedFilterModal(true);
        };

        window.applyAdvancedFilter = () => { 
            const src = window.state.tempAdvFilter;
            const errors = [];
            if (src.useGroupType) { const tid = src.valType; if (!tid) errors.push('type'); }
            if (src.useLoc && !src.valLoc) errors.push('loc');
            if (src.useAtt && !src.valAtt) errors.push('att');
            if (src.useDate) { if (!src.dateStart) errors.push('dateStart'); if (!src.dateEnd) errors.push('dateEnd'); }
            if (errors.length > 0) { window.openAdvancedFilterModal(true, errors); alert("Por favor, informe os dados nos campos das caixas marcadas."); return; }
            window.state.fastFilter.active = false; 
            window.state.fastFilterLabel = 'Eventos Filtrados';
            window.state.advancedFilter = { ...src, active: true }; 
            window.state.searchTerm = ''; 
            window.state.selectedDate = null; 
            window.closeModal(); 
        };
        window.openFilterDate = (f) => { window.state.pickerTarget = `TEMP_${f}`; window.openAgendaModal(); };
        window.openFormDate = () => { window.state.pickerTarget = 'evtDate'; window.openAgendaModal(); };

        /**
         * ==========================================
         * 11. FILTRAGEM FINAL E INIT
         * ==========================================
         */
        function getFilteredEvents() {
            let res = [...window.state.events];
            const af = window.state.advancedFilter;
            const ff = window.state.fastFilter || { active: false };

            if (af.active || ff.active) {
                res = res.filter(e => {
                    if (ff.active) { if (e.date < ff.dateStart || e.date > ff.dateEnd) return false; }
                    if (af.active) {
                        if (af.useStatus) { const isPast = isEventPast(e.date, e.time); if (af.statusVal==='active' && isPast) return false; if (af.statusVal==='inactive' && !isPast) return false; }
                        if (af.useGroupType) { const tid = af.valType; if (tid && e.typeId !== tid) return false; }
                        if (af.useLoc && af.valLoc && e.locationId !== af.valLoc) return false;
                        if (af.useAtt && af.valAtt && e.attendantId !== af.valAtt) return false;
                        if (af.useDate && !ff.active) { if (af.dateStart && e.date < af.dateStart) return false; if (af.dateEnd && e.date > af.dateEnd) return false; }
                    }
                    return true;
                });
            } else {
                const term = window.state.searchTerm.toLowerCase();
                res = res.filter(e => {
                    let mSearch = true; if (window.state.searchTerm) {
                        const type = window.state.types.find(t => t.id === e.typeId); const loc = window.state.locations.find(l => l.id === e.locationId); const att = window.state.attendants.find(a => a.id === e.attendantId);
                        mSearch = (type?.name||'').toLowerCase().includes(term) || (type?.sigla||'').toLowerCase().includes(term) || (loc?.name||'').toLowerCase().includes(term) || (att?.name||'').toLowerCase().includes(term);
                    }
                    let mDate = window.state.selectedDate ? e.date === window.state.selectedDate : true; return mSearch && mDate;
                });
            }
            return res.sort((a, b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
        }

        function getFilterDescription() {
            const af = window.state.advancedFilter;
            const ff = window.state.fastFilter || { active: false };
            if (ff.active) { if (af.active) return `${ff.label} (Filtros Ativos)`; return ff.label; }
            if (af.active) return window.state.fastFilterLabel || "Eventos Filtrados"; 
            if (window.state.searchTerm) return "Resultados da Pesquisa"; 
            if (window.state.selectedDate) return `Eventos do dia: ${formatDate(window.state.selectedDate)}`;
            return "Todos os Eventos";
        }
        function renderNavMenu() { 
            if (!window.state.isMenuOpen) return ''; 
            return `<div class="fixed inset-0 z-50"><div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="window.closeMenu()"></div><div class="relative w-72 h-full bg-navy text-white flex flex-col shadow-2xl"><div class="p-6 border-b border-white/10 flex justify-between bg-[#002855]"><h2 class="text-xl font-bold">Menu</h2><button onclick="window.closeMenu()"><i data-lucide="x"></i></button></div><nav class="flex-1 py-4 flex flex-col gap-1 overflow-y-auto">${[{id: 'home', icon: 'calendar', label: 'Início'}, {id: 'types', icon: 'tag', label: 'Tipos de Eventos'}, {id: 'locations', icon: 'map-pin', label: 'Localidades'}, {id: 'attendants', icon: 'users', label: 'Atendentes'}, {id: 'about', icon: 'info', label: 'Sobre'}].map(i => `<button onclick="window.navigateTo('${i.id}')" class="w-full flex items-center px-6 py-4 hover:bg-white/10 gap-3 border-l-4 border-transparent hover:border-orange-custom"><i data-lucide="${i.icon}" class="text-orange-custom"></i><span>${i.label}</span></button>`).join('')}</nav><div class="p-4 border-t border-white/10 bg-[#002244]">${window.state.user ? `<button onclick="window.handleLogout()" class="w-full flex justify-center gap-2 px-4 py-3 bg-red-600/20 text-red-200 rounded-lg font-bold"><i data-lucide="log-out" class="w-4 h-4"></i> Sair</button>` : `<button onclick="window.showLoginModal()" class="w-full flex justify-center gap-2 px-4 py-3 bg-white/10 text-white rounded-lg font-bold"><i data-lucide="lock" class="w-4 h-4"></i> Login</button>`}</div></div></div>`; 
        }
        function renderAbout() { 
            const app = document.getElementById('app'); 
            app.innerHTML = `
                <div class="flex flex-col h-screen bg-slate-100">
                    <div class="bg-navy text-white p-4 flex justify-between items-center shadow-lg z-10 shrink-0">
                        <div class="flex items-center gap-3">
                            <button onclick="window.navigateTo('home')" class="hover:bg-white/10 p-1 rounded-full"><i data-lucide="arrow-left"></i></button>
                            <h1 class="font-bold uppercase tracking-wide text-sm sm:text-base">Sobre o App</h1>
                        </div>
                        <button onclick="window.resetAllFilters(); window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded" title="Início"><i data-lucide="home" class="w-7 h-7"></i></button>
                    </div>
                    <div class="p-3 flex flex-col gap-3 text-slate-600 max-w-sm mx-auto overflow-hidden h-full">
                        <div class="flex flex-col items-center gap-2 bg-white p-3 rounded-xl border border-slate-200 shadow-sm shrink-0">
                            <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-navy shadow-inner border border-blue-100">
                                <i data-lucide="calendar-check-2" class="w-6 h-6"></i>
                            </div>
                            <div class="text-center">
                                <h2 class="text-lg font-black text-navy leading-tight">Eventos Adm Valente</h2>
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Agenda Administrativa</p>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 flex-1 overflow-y-auto">
                            <h3 class="font-bold text-navy mb-2 flex items-center gap-2 text-xs uppercase"><i data-lucide="zap" class="w-3 h-3 text-orange-custom"></i> Funcionalidades</h3>
                            <ul class="text-[11px] sm:text-xs space-y-1.5 text-slate-600"> 
                                <li class="flex items-start gap-2"><i data-lucide="check" class="w-3 h-3 text-green-500 mt-0.5 shrink-0"></i> <span>Gestão de eventos, categorias e atendentes.</span></li> 
                                <li class="flex items-start gap-2"><i data-lucide="calendar" class="w-3 h-3 text-green-500 mt-0.5 shrink-0"></i> <span>Agenda mensal e diária interativa.</span></li> 
                                <li class="flex items-start gap-2"><i data-lucide="filter" class="w-3 h-3 text-green-500 mt-0.5 shrink-0"></i> <span>Filtros avançados e buscas precisas.</span></li> 
                                <li class="flex items-start gap-2"><i data-lucide="file-text" class="w-3 h-3 text-green-500 mt-0.5 shrink-0"></i> <span>Relatórios em PDF e PNG de alta nitidez.</span></li> 
                                <li class="flex items-start gap-2"><i data-lucide="shield-check" class="w-3 h-3 text-green-500 mt-0.5 shrink-0"></i> <span>Segurança e acesso administrativo.</span></li>
                            </ul>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center shrink-0">
                            <p class="text-xs font-medium text-slate-700">Desenvolvido por:</p>
                            <p class="text-sm font-black text-navy mt-0.5">Marcos de Lima</p>
                            <p class="text-[9px] text-slate-400 font-bold uppercase mt-1">Versão 2.4.0</p>
                        </div>
                    </div>
                </div>`; 
            window.renderIcons();
        }

        window.startCreateEvent = () => { 
            window.state.editingEventId = null; 
            window.state.formOriginalValues = null;
            window.state.formTempDate = ''; 
            window.state.formTempTime = ''; 
            window.state.formTempLoc = '';
            window.state.formTempType = '';
            window.state.formTempAtt = '';
            window.navigateTo('event-form'); 
        };
        window.addEventListener('popstate', (event) => {
            if (window.state.isMenuOpen) { window.state.isMenuOpen = false; return; }
            const modal = document.getElementById('modal-container');
            if (modal && !modal.classList.contains('hidden')) { window.closeModal(); scheduleRender(); return; }
            if (event.state && event.state.screen) {
                window.state.currentScreen = event.state.screen;
                if (event.state.screen === 'home') { window.state.editingEventId = null; window.state.formOriginalValues = null; }
            } else window.state.currentScreen = 'home';
        });

        async function registerSW() {
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('./sw.js', { scope: './' });
                } catch (e) { console.warn('Registro de SW falhou:', e); }
            }
        }

        window.fetchHolidays = async (year) => {
            if (!window.state.holidaysFetchedYears) window.state.holidaysFetchedYears = [];
            if (window.state.holidaysFetchedYears.includes(year)) return;
            try {
                const response = await fetch(`https://brasilapi.com.br/api/feriados/v1/${year}`);
                if (!response.ok) return;
                const data = await response.json();
                const fetched = data.map(h => ({ date: h.date, name: h.name }));
                const baHoliday = { date: `${year}-07-02`, name: 'Independência da Bahia' };
                if (!fetched.find(h => h.date === baHoliday.date)) fetched.push(baHoliday);
                window.state.holidays = [...(window.state.holidays || []), ...fetched];
                window.state.holidaysFetchedYears.push(year);
                if (window.state.currentScreen === 'home') scheduleRender();
            } catch (e) { console.error('Erro ao buscar feriados:', e); }
        };

        window.showDuplicateWarning = (text, onLocate, onBackToEdit) => {
            window.showModal(`
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 border-t-4 border-orange-custom">
                    <h3 class="text-lg font-bold text-navy mb-2 flex items-center gap-2"><i data-lucide="copy" class="text-orange-custom"></i> Registro Duplicado</h3>
                    <p class="text-slate-600 mb-6 text-sm font-medium leading-relaxed">${text}</p>
                    <div class="flex flex-col gap-2">
                        <button id="locate-dup-btn" class="w-full py-3 bg-navy text-white rounded-lg font-bold shadow-lg hover:bg-navy-dark flex items-center justify-center gap-2"><i data-lucide="search" class="w-4 h-4"></i> Localizar Duplicata</button>
                        <button id="back-to-edit-btn" class="w-full py-3 bg-slate-100 text-slate-600 rounded-lg font-bold hover:bg-slate-200">Cancelar e Editar</button>
                    </div>
                </div>
            `);
            document.getElementById('locate-dup-btn').onclick = () => { onLocate(); window.closeModal(); };
            document.getElementById('back-to-edit-btn').onclick = () => { onBackToEdit(); };
        };

        (async function init() {
            registerSW();
            const cachedCollections = ['events', 'types', 'locations', 'attendants'];
            for (const key of cachedCollections) {
                const cached = await loadCache(key); if (cached) window.state[key] = cached;
            }
            
            history.replaceState({ screen: 'home' }, '', '');
            
            onAuthStateChanged(auth, (u) => { 
                window.state.user = u; 
                window.state.isAdmin = u?.uid === ADMIN_UID; 
            });

            const collectionsMap = { 'agenda': 'events', 'types': 'types', 'locations': 'locations', 'attendants': 'attendants' };
            Object.keys(collectionsMap).forEach(colName => {
                onSnapshot(collection(db, colName), snap => { 
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    window.state[collectionsMap[colName]] = data; 
                });
            });

            const y = new Date().getFullYear();
            window.fetchHolidays(y);
            window.fetchHolidays(y + 1);
        })();

        window.saveEvent = window.saveEvent || saveEvent;
        window.deleteEvent = window.deleteEvent || deleteEvent;
        window.saveGenericRow = window.saveGenericRow || saveGenericRow;
        window.requestDeleteRow = window.requestDeleteRow || requestDeleteRow;
        window.handleLogout = window.handleLogout || handleLogout;

    </script>
</body>
</html>
