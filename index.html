<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eventos Adm Valente</title>
    <meta name="description" content="Gerenciador de Agenda Administrativa">
    <meta name="theme-color" content="#003366">
    
    <!-- Bibliotecas Externas (CDNs) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    
    <!-- PDF & Image Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase Compat (V8 namespaced API) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        html, body, * { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-navy { background-color: #003366; } .text-navy { color: #003366; } .border-navy { border-color: #003366; } .hover-bg-navy-dark:hover { background-color: #002855; }
        .bg-orange-custom { background-color: #FF8C00; } .text-orange-custom { color: #FF8C00; } .border-orange-custom { border-color: #FF8C00; } .hover-bg-orange-dark:hover { background-color: #e67e00; }
        
        .animate-in { animation-duration: 0.2s; animation-fill-mode: both; }
        .fade-in { animation-name: fadeIn; } .zoom-in { animation-name: zoomIn; } .slide-in { animation: slideIn 0.3s ease-out; } .slide-in-from-top-2 { animation: slideInTop 0.2s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes slideInTop { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        input:focus, select:focus, textarea:focus { outline: none; }
        input:-webkit-autofill { -webkit-box-shadow: 0 0 0 30px white inset !important; }
        
        .disabled-area { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; animation: shake 0.3s ease-in-out; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            background-color: #f1f5f9;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #003366;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        .loading-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: #94a3b8;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "firebase/": "https://esm.sh/firebase@^12.7.0/"
  }
}
</script>
</head>
<body class="h-screen w-full flex flex-col bg-slate-100">

    <!-- App Root -->
    <div id="app" class="flex-1 w-full h-full relative overflow-hidden flex flex-col">
        <div class="loading-container" id="initial-loading">
            <div class="loading-spinner"></div>
            <span class="loading-text">Carregando Agenda Administrativa...</span>
        </div>
    </div>

    <!-- Modals Overlay -->
    <div id="modal-container" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>

    <!-- Template: Login Modal -->
    <template id="login-modal-template">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in">
            <div class="p-5 border-b border-slate-100 bg-slate-50 text-center">
                <h3 class="font-bold text-lg text-navy">Área Administrativa</h3>
                <p class="text-xs text-slate-400">Entre com suas credenciais para gerenciar</p>
            </div>
            <form id="login-form" class="p-6 flex flex-col gap-4">
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">Email</label>
                    <input type="email" id="login-email" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-navy/20" required>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">Senha</label>
                    <input type="password" id="login-password" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-navy/20" required>
                </div>
                <div id="login-error" class="text-red-500 text-xs hidden font-medium text-center"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="window.closeModal()" class="flex-1 py-3 rounded-lg bg-slate-100 font-bold text-slate-600 hover:bg-slate-200">Cancelar</button>
                    <button type="submit" class="flex-1 py-3 rounded-lg bg-navy text-white font-bold hover:bg-navy-dark shadow-lg">Entrar</button>
                </div>
            </form>
        </div>
    </template>

    <script>
        /**
         * ==========================================
         * 1. FIREBASE CONFIGURATION & INITIALIZATION
         * ==========================================
         */
        const firebaseConfig = { 
            apiKey: "AIzaSyCmceNv1eBJLj7aWMcR7crvSVxonuzDVQo", 
            authDomain: "agendaadmvalente.firebaseapp.com", 
            projectId: "agendaadmvalente", 
            storageBucket: "agendaadmvalente.firebasestorage.app", 
            messagingSenderId: "810572581910", 
            appId: "1:810572581910:web:155a7e18f6c46f77faf937" 
        };

        const ADMIN_UID = "kRzVsk2nqNTyj79Lk4h6Fmhk7JP2";

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Ativar persistência offline
        async function initPersistence() {
            try {
                await db.enablePersistence();
                console.log("Persistência offline ativada.");
            } catch (err) {
                console.warn("Persistência falhou:", err.code);
            }
        }

        /**
         * ==========================================
         * 2. STATE MANAGEMENT (PROXY)
         * ==========================================
         */
        const defaultAdvancedFilter = {
            active: false,
            useStatus: false, statusVal: 'active',
            useGroupType: false, selectedRadio: 'type', valType: '', valSigla: '',
            useLoc: false, valLoc: '',
            useAtt: false, valAtt: '',
            useDate: false, dateStart: '', dateEnd: ''
        };

        const INITIAL_STATE = {
            user: null, isAdmin: false, currentScreen: 'home',
            events: [], types: [], locations: [], attendants: [],
            isMenuOpen: false, editingEventId: null, isViewAll: false,
            searchTerm: '', filterStartDate: '', filterEndDate: '',
            advancedFilter: JSON.parse(JSON.stringify(defaultAdvancedFilter)),
            tempAdvFilter: null, pickerTarget: null, timePickerTarget: null, selectedDate: null, viewDate: new Date(),
            editingRowId: null, isCreatingRow: false, tempName: '', tempSigla: '', managerSearchTerm: '',
            formTempDate: '', formTempTime: ''
        };

        const state = new Proxy(INITIAL_STATE, {
            set(target, property, value) {
                target[property] = value;
                
                // Otimização de re-render
                if (typeof property === 'string') {
                    if (!['tempName', 'tempSigla', 'managerSearchTerm', 'searchTerm', 'formTempDate', 'formTempTime'].includes(property)) { 
                        renderApp(); 
                    } else { 
                        // Casos específicos onde inputs precisam disparar atualizações parciais
                        if (property === 'searchTerm') { 
                            if (value) {
                                target.advancedFilter.active = false;
                                target.isViewAll = false;
                                target.selectedDate = null;
                                target.filterStartDate = '';
                                target.filterEndDate = '';
                            }
                            window.updateHomeList(); 
                        }
                        if (property === 'managerSearchTerm') renderApp(); 
                        if (property === 'formTempDate' || property === 'formTempTime') {
                             if (target.currentScreen === 'event-form') renderEventForm();
                        }
                    }
                }
                return true;
            }
        });
        window.state = state;

        /**
         * ==========================================
         * 3. UTILS
         * ==========================================
         */
        const formatDate = (dateStr) => { if (!dateStr) return ''; const parts = dateStr.split('-'); return parts.length === 3 ? `${parts[2]}/${parts[1]}/${parts[0].slice(2)}` : dateStr; };
        const formatDateFull = (dateStr) => { if (!dateStr) return ''; const parts = dateStr.split('-'); return parts.length === 3 ? `${parts[2]}/${parts[1]}/${parts[0]}` : dateStr; };
        const isEventPast = (date, time) => new Date(`${date}T${time}`) < new Date();
        const renderIcons = () => { if(window.lucide) window.lucide.createIcons(); };
        window.renderIcons = renderIcons;

        /**
         * ==========================================
         * 4. RENDERERS
         * ==========================================
         */
        function renderApp() {
            // Se houver modal de calendário ou filtro avançado impedindo a interação, não re-renderiza a base
            if (document.getElementById('calendar-modal-content')) return; 
            if (document.getElementById('advanced-filter-modal')) return;
            
            switch (state.currentScreen) {
                case 'home': renderHome(); break; 
                case 'event-form': renderEventForm(); break; 
                case 'types': renderGenericManager('Tipos de Eventos', 'types', 'Tipo', true); break; 
                case 'locations': renderGenericManager('Localidades', 'locations', 'Localidade', false); break; 
                case 'attendants': renderGenericManager('Atendentes', 'attendants', 'Atendente', false); break; 
                case 'about': renderAbout(); break;
            }
            renderIcons();
        }

        // --- HOME ---
        function renderHome() {
            const app = document.getElementById('app'); 
            let container = document.getElementById('home-container');
            
            if (!container) {
                app.innerHTML = `
                    <div id="home-container" class="flex flex-col h-full bg-slate-100 relative">
                        <div id="nav-menu-placeholder"></div>
                        <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
                            <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded">
                                <i data-lucide="menu" class="w-7 h-7"></i>
                            </button>
                            <h1 class="text-lg font-bold uppercase tracking-wide">Eventos Adm Valente</h1>
                            <div class="w-8"></div>
                        </div>
                        <div class="flex flex-col flex-1 overflow-hidden p-4 gap-4 max-w-xl mx-auto w-full overflow-y-auto">
                            <div class="flex flex-col gap-3">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="flex gap-2">
                                        <button onclick="window.startOpenAgenda()" class="flex items-center gap-1 px-3 py-1.5 bg-navy text-white text-xs font-bold rounded shadow">
                                            <i data-lucide="calendar" class="w-3 h-3"></i> Agenda
                                        </button>
                                        <button onclick="window.resetAllFilters()" class="flex items-center gap-1 px-3 py-1.5 bg-navy text-white text-xs font-bold rounded shadow">
                                            <i data-lucide="list" class="w-3 h-3"></i> Todos
                                        </button>
                                    </div>
                                    <button onclick="window.openPDFPreview()" class="flex items-center gap-1 px-3 py-1.5 bg-navy text-white text-xs font-bold rounded shadow">
                                        <i data-lucide="file-text" class="w-3 h-3"></i> Exportar
                                    </button>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <div class="relative flex-1">
                                        <input id="homeSearch" type="text" placeholder="Pesquisar..." class="w-full pl-10 pr-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-navy/20 shadow-sm" oninput="window.state.searchTerm = this.value">
                                        <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
                                    </div>
                                    <button onclick="window.openAdvancedFilterModal()" class="p-2 bg-white border border-slate-300 rounded-lg shadow-sm text-navy">
                                        <i data-lucide="zoom-in" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="event-list-container" class="flex flex-col gap-2 flex-1 min-h-0"></div>
                        </div>
                        <div id="fab-container"></div>
                    </div>
                `;
            }
            
            const searchInput = document.getElementById('homeSearch');
            if (searchInput && document.activeElement !== searchInput) searchInput.value = state.searchTerm;
            
            const navPlaceholder = document.getElementById('nav-menu-placeholder'); 
            if(navPlaceholder) navPlaceholder.innerHTML = renderNavMenu();
            
            const fabContainer = document.getElementById('fab-container'); 
            if(fabContainer) fabContainer.innerHTML = state.isAdmin ? `
                <button onclick="window.startCreateEvent()" class="fixed bottom-6 right-6 w-14 h-14 bg-orange-custom text-white rounded-full shadow-xl flex items-center justify-center active:scale-90 transition-all z-50 border border-white/20">
                    <i data-lucide="plus" class="w-7 h-7"></i>
                </button>` : '';
            
            window.updateHomeList();
        }

        window.updateHomeList = () => {
            const filtered = getFilteredEvents(); 
            const desc = getFilterDescription();
            const container = document.getElementById('event-list-container');
            if(!container) return;

            container.innerHTML = `
                <div class="flex justify-between items-end px-1">
                    <label class="text-sm font-bold text-navy truncate flex-1 pr-2">${desc}</label>
                    <span class="text-xs font-medium text-slate-400 flex-shrink-0">${filtered.length} registros</span>
                </div>
                <div class="flex-1 overflow-y-auto border border-slate-200 bg-slate-50 rounded-xl shadow-md min-h-0">
                    ${filtered.length === 0 ? 
                        `<div class="h-full flex items-center justify-center text-slate-400 p-8 text-center italic">Nenhum evento encontrado.</div>` : 
                        `<ul class="divide-y divide-slate-200/50">
                            ${filtered.map((e) => { 
                                const type = state.types.find(t => t.id === e.typeId); 
                                const loc = state.locations.find(l => l.id === e.locationId); 
                                const att = state.attendants.find(a => a.id === e.attendantId); 
                                const isPast = isEventPast(e.date, e.time); 
                                return `
                                    <li onclick="${state.isAdmin ? `window.openEditEvent('${e.id}')` : ''}" class="p-3 border-b border-slate-200/50 last:border-0 ${state.isAdmin ? 'cursor-pointer hover:bg-slate-100' : ''} ${isPast ? 'opacity-75 grayscale-[0.5]' : ''}">
                                        <div class="flex items-start gap-3">
                                            <div class="w-11 h-11 rounded-xl border flex items-center justify-center flex-shrink-0 ${isPast ? 'bg-slate-100 text-slate-400' : 'bg-blue-50 text-navy border-blue-100'}">
                                                <i data-lucide="${isPast ? 'check-circle-2' : 'calendar-clock'}" class="w-5 h-5"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex justify-between items-start mb-0.5">
                                                    <h3 class="font-bold text-navy pr-2 leading-tight truncate">${type?.name||'Evento'}</h3>
                                                    ${type?.sigla ? `<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-slate-200 text-slate-600 uppercase">${type.sigla}</span>` : ''}
                                                </div>
                                                <div class="text-xs font-semibold text-slate-500 mb-1">${formatDate(e.date)} às ${e.time}</div>
                                                <div class="flex flex-col text-[11px] text-slate-600 gap-0.5">
                                                    <div class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3 text-orange-custom"></i> <span class="truncate">${loc?.name || '-'}</span></div>
                                                    <div class="flex items-center gap-1"><i data-lucide="user" class="w-3 h-3 text-navy"></i> <span class="truncate">${att?.name || '-'}</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                `; 
                            }).join('')}
                        </ul>`
                    }
                </div>
            `;
            renderIcons();
        };

        // --- FORM ---
        function renderEventForm() {
            const app = document.getElementById('app'); 
            const isEditing = !!state.editingEventId; 
            const event = isEditing ? state.events.find(e => e.id === state.editingEventId) : null;
            
            const dateVal = state.formTempDate || (event?.date || '');
            const timeVal = state.formTempTime || (event?.time || '');
            const locVal = event?.locationId || '';
            const typeVal = event?.typeId || '';
            const attVal = event?.attendantId || '';

            const sortedLocs = [...state.locations].sort((a, b) => a.name.localeCompare(b.name));
            const sortedTypes = [...state.types].sort((a, b) => a.name.localeCompare(b.name));
            const sortedAtts = [...state.attendants].sort((a, b) => a.name.localeCompare(b.name));

            app.innerHTML = `
                <div id="event-form-container" class="flex flex-col h-screen bg-slate-100">
                    <div class="bg-navy text-white p-4 flex items-center gap-3 shadow-lg z-10">
                        <button onclick="window.navigateTo('home')" class="hover:bg-white/10 p-1 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <h1 class="font-bold uppercase tracking-wide">${isEditing ? 'Editar' : 'Novo'} Evento</h1>
                    </div>
                    <div class="p-4 flex flex-col gap-4 max-w-xl mx-auto w-full overflow-y-auto">
                        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 flex flex-col gap-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Data *</label>
                                    <button type="button" id="btnDate" onclick="window.openFormDate()" class="w-full p-3 border border-slate-300 rounded-lg text-left text-slate-800 bg-white flex items-center gap-2">
                                        <i data-lucide="calendar" class="w-4 h-4 text-navy"></i> ${dateVal ? formatDateFull(dateVal) : 'Selecione'}
                                    </button>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hora *</label>
                                    <button type="button" id="btnTime" onclick="window.openTimePickerModal('evtTime')" class="w-full p-3 border border-slate-300 rounded-lg text-left text-slate-800 bg-white flex items-center gap-2">
                                        <i data-lucide="clock" class="w-4 h-4 text-navy"></i> ${timeVal || '00:00'}
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Localidade *</label>
                                <select id="evtLoc" class="w-full p-3 border border-slate-300 rounded-lg bg-white">
                                    <option value="">Selecione...</option>
                                    ${sortedLocs.map(l => `<option value="${l.id}" ${l.id === locVal ? 'selected' : ''}>${l.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tipo de Evento *</label>
                                <select id="evtType" class="w-full p-3 border border-slate-300 rounded-lg bg-white">
                                    <option value="">Selecione...</option>
                                    ${sortedTypes.map(t => `<option value="${t.id}" ${t.id === typeVal ? 'selected' : ''}>${t.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Atendente</label>
                                <select id="evtAtt" class="w-full p-3 border border-slate-300 rounded-lg bg-white">
                                    <option value="">Selecione...</option>
                                    ${sortedAtts.map(a => `<option value="${a.id}" ${a.id === attVal ? 'selected' : ''}>${a.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="pt-4 flex flex-col gap-3 border-t mt-2">
                                ${state.isAdmin ? `
                                    <button type="button" onclick="window.saveEvent()" class="w-full py-4 bg-navy text-white rounded-lg font-bold shadow-lg flex items-center justify-center gap-2">
                                        <i data-lucide="save" class="w-5 h-5"></i> Salvar Evento
                                    </button>` : ''}
                                ${isEditing && state.isAdmin ? `
                                    <button type="button" onclick="window.deleteEvent()" class="w-full py-3 border border-red-200 text-red-600 bg-red-50 rounded-lg font-bold flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i> Excluir
                                    </button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            renderIcons();
        }

        // --- MANAGERS ---
        function renderGenericManager(title, key, label, hasSigla) { 
            const app = document.getElementById('app'); 
            const list = (state[key] || []).sort((a, b) => a.name.localeCompare(b.name));
            
            app.innerHTML = `
                <div class="flex flex-col h-screen bg-slate-100">
                    <div class="bg-navy text-white p-4 flex items-center gap-3 shadow-lg z-10">
                        <button onclick="window.navigateTo('home')" class="hover:bg-white/10 p-1 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <h1 class="font-bold uppercase tracking-wide">${title}</h1>
                    </div>
                    <div class="p-4 flex-1 overflow-hidden flex flex-col gap-4 max-w-xl mx-auto w-full">
                        <div class="relative shrink-0">
                            <input type="text" placeholder="Pesquisar..." class="w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg shadow-sm" oninput="window.state.managerSearchTerm = this.value" value="${state.managerSearchTerm}">
                            <i data-lucide="search" class="absolute left-3 top-3.5 text-slate-400 w-5 h-5"></i>
                        </div>
                        
                        ${state.isCreatingRow ? renderInlineRow(null, label, hasSigla, true) : ''}
                        
                        <div class="flex-1 overflow-y-auto border border-slate-200 bg-slate-50 rounded-xl shadow-md min-h-0">
                            <ul class="divide-y divide-slate-200/50">
                                ${list.filter(i => i.name.toLowerCase().includes(state.managerSearchTerm.toLowerCase())).map(i => {
                                    if (state.editingRowId === i.id) return `<li class="p-3 bg-blue-50">${renderInlineRow(i, label, hasSigla, false)}</li>`;
                                    return `
                                        <li class="p-4 bg-white hover:bg-slate-50 transition-colors flex items-center justify-between">
                                            <div class="min-w-0 flex-1">
                                                <span class="font-bold text-navy truncate block">${i.name}</span>
                                                ${hasSigla && i.sigla ? `<span class="text-[10px] text-slate-400 font-black uppercase">Sigla: ${i.sigla}</span>` : ''}
                                            </div>
                                            ${state.isAdmin ? `
                                            <div class="flex gap-1 ml-4">
                                                <button onclick="window.startEditRow('${i.id}')" class="p-2 text-blue-600 bg-blue-50 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                                <button onclick="window.requestDeleteRow('${i.id}', '${key}', '${i.name}')" class="p-2 text-red-600 bg-red-50 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>` : ''}
                                        </li>
                                    `;
                                }).join('')}
                            </ul>
                        </div>
                        ${state.isAdmin && !state.isCreatingRow ? `
                        <button onclick="window.startCreateRow()" class="w-full py-4 bg-navy text-white rounded-lg font-bold shadow-lg flex items-center justify-center gap-2">
                            <i data-lucide="plus" class="w-5 h-5"></i> Adicionar ${label}
                        </button>` : ''}
                    </div>
                </div>
            `;
            renderIcons();
        }

        function renderInlineRow(item, lbl, sigla, isNew) { 
            return `
                <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200 shadow-inner">
                    <div class="mb-3">
                        <label class="text-[10px] font-black text-navy uppercase mb-1 block">${lbl}</label>
                        <input id="editNameInput" class="w-full p-3 border border-blue-200 rounded-lg text-sm" placeholder="Nome completo" value="${isNew ? state.tempName : (state.tempName || item.name)}" oninput="window.state.tempName=this.value">
                    </div>
                    ${sigla ? `
                    <div class="mb-4">
                        <label class="text-[10px] font-black text-navy uppercase mb-1 block">Sigla</label>
                        <input class="w-full p-3 border border-blue-200 rounded-lg uppercase text-sm" placeholder="Ex: ADM" maxlength="5" value="${isNew ? state.tempSigla : (state.tempSigla || item.sigla)}" oninput="window.state.tempSigla=this.value.toUpperCase()">
                    </div>` : ''}
                    <div class="flex gap-2">
                        <button onclick="window.saveGenericRow('${isNew?'':item.id}', '${sigla}')" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold text-sm shadow-md">Salvar</button>
                        <button onclick="window.cancelGenericEdit()" class="flex-1 bg-slate-300 text-slate-700 py-3 rounded-lg font-bold text-sm">Cancelar</button>
                    </div>
                </div>`; 
        }

        // --- SIDE MENU ---
        function renderNavMenu() { 
            if (!state.isMenuOpen) return ''; 
            const items = [
                {id: 'home', icon: 'calendar', label: 'Início'}, 
                {id: 'types', icon: 'tag', label: 'Tipos de Eventos'}, 
                {id: 'locations', icon: 'map-pin', label: 'Localidades'}, 
                {id: 'attendants', icon: 'users', label: 'Atendentes'}, 
                {id: 'about', icon: 'info', label: 'Sobre'}
            ];
            return `
                <div class="fixed inset-0 z-50">
                    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="window.closeMenu()"></div>
                    <div class="relative w-72 h-full bg-navy text-white flex flex-col shadow-2xl animate-in slide-in">
                        <div class="p-8 border-b border-white/10 bg-[#002855]">
                            <h2 class="text-xl font-black uppercase tracking-tighter">Menu Adm</h2>
                            <p class="text-[10px] text-slate-400 mt-1">SISTEMA DE GESTÃO VALENTE</p>
                        </div>
                        <nav class="flex-1 py-6 flex flex-col gap-1">
                            ${items.map(i => `
                                <button onclick="window.navigateTo('${i.id}')" class="w-full flex items-center px-8 py-4 hover:bg-white/10 gap-4 transition-colors ${state.currentScreen === i.id ? 'border-l-4 border-orange-custom bg-white/5 font-bold' : 'border-l-4 border-transparent text-slate-300'}">
                                    <i data-lucide="${i.icon}" class="${state.currentScreen === i.id ? 'text-orange-custom' : ''}"></i>
                                    <span>${i.label}</span>
                                </button>
                            `).join('')}
                        </nav>
                        <div class="p-6 border-t border-white/10 bg-[#002244]">
                            ${state.user ? `
                                <div class="text-[10px] text-slate-400 mb-3 truncate">${state.user.email}</div>
                                <button onclick="window.handleLogout()" class="w-full flex justify-center items-center gap-2 px-4 py-3 bg-red-600/20 text-red-400 rounded-lg font-bold hover:bg-red-600/30">
                                    <i data-lucide="log-out" class="w-4 h-4"></i> Sair
                                </button>` : `
                                <button onclick="window.showLoginModal()" class="w-full flex justify-center items-center gap-2 px-4 py-3 bg-white/10 text-white rounded-lg font-bold hover:bg-white/20">
                                    <i data-lucide="lock" class="w-4 h-4"></i> Login Admin
                                </button>`}
                        </div>
                    </div>
                </div>`; 
        }

        function renderAbout() { 
            const app = document.getElementById('app'); 
            app.innerHTML = `
                <div class="flex flex-col h-screen bg-slate-100">
                    <div class="bg-navy text-white p-4 flex items-center gap-3 shadow-lg">
                        <button onclick="window.navigateTo('home')" class="hover:bg-white/10 p-1 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <h1 class="font-bold uppercase tracking-wide">Sobre</h1>
                    </div>
                    <div class="p-8 flex flex-col gap-6 text-center text-slate-600 max-w-md mx-auto">
                        <div class="w-20 h-20 bg-navy rounded-3xl flex items-center justify-center mx-auto text-white shadow-xl rotate-3">
                            <i data-lucide="calendar-check-2" class="w-10 h-10"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-black text-navy mb-2 tracking-tighter uppercase">Adm Valente</h2>
                            <p class="text-sm leading-relaxed font-medium">Gestor administrativo para controle de eventos, localidades e atendentes com suporte a funcionamento offline e relatórios.</p>
                            <div class="mt-10 pt-6 border-t border-slate-200">
                                <div class="text-[10px] font-black text-slate-400 uppercase mb-1">Desenvolvido por</div>
                                <div class="text-base font-bold text-navy">Marcos de Lima</div>
                                <div class="text-[9px] text-slate-400 mt-4 uppercase">Versão Final 1.0.0</div>
                            </div>
                        </div>
                    </div>
                </div>`; 
            renderIcons();
        }

        /**
         * ==========================================
         * 5. ACTIONS & LOGIC
         * ==========================================
         */
        window.navigateTo = (screen) => { 
            state.isMenuOpen = false; 
            state.currentScreen = screen; 
            state.editingRowId = null; 
            state.isCreatingRow = false; 
            state.tempName = ''; 
            state.tempSigla = ''; 
            state.managerSearchTerm = '';
            state.formTempDate = '';
            state.formTempTime = '';
        };

        window.handleLogout = async () => { await auth.signOut(); state.isMenuOpen = false; };
        window.closeModal = () => { const c = document.getElementById('modal-container'); c.classList.add('hidden'); c.innerHTML = ''; };
        window.showModal = (html) => { const c = document.getElementById('modal-container'); c.innerHTML = html; c.classList.remove('hidden'); renderIcons(); };

        window.openMenu = () => { state.isMenuOpen = true; renderApp(); };
        window.closeMenu = () => { state.isMenuOpen = false; renderApp(); };

        window.showLoginModal = () => { 
            window.closeMenu();
            const t = document.getElementById('login-modal-template'); 
            window.showModal('');
            const container = document.getElementById('modal-container');
            container.appendChild(t.content.cloneNode(true)); 
            
            const form = document.getElementById('login-form'); 
            form.onsubmit = async (e) => { 
                e.preventDefault(); 
                const errEl = document.getElementById('login-error');
                errEl.classList.add('hidden');
                try { 
                    await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); 
                    window.closeModal(); 
                } catch (e) { 
                    errEl.textContent = "Erro de autenticação. Verifique os dados."; 
                    errEl.classList.remove('hidden'); 
                }
            }; 
        };

        // --- FILTER HELPERS ---
        function getFilteredEvents() {
            let res = [...state.events];
            if (state.advancedFilter.active) {
                const af = state.advancedFilter;
                res = res.filter(e => {
                    if (af.useStatus) {
                        const past = isEventPast(e.date, e.time);
                        if (af.statusVal === 'active' && past) return false;
                        if (af.statusVal === 'inactive' && !past) return false;
                    }
                    if (af.useGroupType) {
                        const tid = af.selectedRadio === 'type' ? af.valType : af.valSigla;
                        if (e.typeId !== tid) return false;
                    }
                    if (af.useLoc && e.locationId !== af.valLoc) return false;
                    if (af.useAtt && e.attendantId !== af.valAtt) return false;
                    if (af.useDate && (e.date < af.dateStart || e.date > af.dateEnd)) return false;
                    return true;
                });
            } else {
                const term = state.searchTerm.toLowerCase();
                res = res.filter(e => {
                    const type = state.types.find(t => t.id === e.typeId);
                    const loc = state.locations.find(l => l.id === e.locationId);
                    const att = state.attendants.find(a => a.id === e.attendantId);
                    const matchSearch = !term || (
                        (type?.name||'').toLowerCase().includes(term) || (type?.sigla||'').toLowerCase().includes(term) ||
                        (loc?.name||'').toLowerCase().includes(term) || (att?.name||'').toLowerCase().includes(term)
                    );
                    const matchDate = !state.selectedDate || e.date === state.selectedDate;
                    return matchSearch && matchDate;
                });
            }
            return res.sort((a,b) => (a.date + a.time).localeCompare(b.date + b.time));
        }

        function getFilterDescription() {
            if (state.advancedFilter.active) return "Eventos Filtrados"; 
            if (state.searchTerm) return "Pesquisa"; 
            if (state.selectedDate) return `Eventos em ${formatDate(state.selectedDate)}`;
            return "Todos os Eventos";
        }

        // --- AGENDA / MODALS ---
        window.startOpenAgenda = () => { state.pickerTarget = null; state.viewDate = new Date(); window.openAgendaModal(); };
        window.resetAllFilters = () => { state.searchTerm = ''; state.selectedDate = null; state.advancedFilter.active = false; renderApp(); };
        window.startCreateEvent = () => { state.editingEventId = null; state.formTempDate = new Date().toISOString().split('T')[0]; state.formTempTime = '08:00'; window.navigateTo('event-form'); };
        window.openEditEvent = (id) => { const e = state.events.find(ev => ev.id === id); if(e) { state.editingEventId = id; state.formTempDate = e.date; state.formTempTime = e.time; window.navigateTo('event-form'); } };

        window.openAgendaModal = () => {
            const year = state.viewDate.getFullYear(); const month = state.viewDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            let grid = '';
            for (let i = 0; i < firstDay; i++) grid += `<div class="aspect-square"></div>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasEv = state.events.some(e => e.date === ds);
                const isSel = state.selectedDate === ds;
                grid += `
                    <button onclick="window.toggleDateSelection('${ds}')" class="aspect-square flex flex-col items-center justify-center rounded-lg border text-xs ${isSel ? 'bg-navy text-white font-bold border-navy' : 'hover:bg-slate-100 border-transparent'}">
                        <span>${d}</span>
                        ${hasEv && !isSel ? '<span class="w-1 h-1 bg-orange-custom rounded-full mt-0.5"></span>' : ''}
                    </button>`;
            }

            window.showModal(`
                <div id="calendar-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-5 flex flex-col animate-in zoom-in">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="font-bold text-navy uppercase text-sm">${state.pickerTarget ? 'Selecione a Data' : 'Agenda'}</h3>
                        <button onclick="window.closeModal()" class="text-slate-400 hover:text-navy"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <div class="flex justify-between items-center mb-4 bg-slate-50 p-1.5 rounded-lg">
                        <button onclick="window.changeMonth(-1)" class="p-1 hover:bg-white rounded shadow-sm"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        <span class="font-bold text-navy text-xs uppercase">${monthNames[month]} ${year}</span>
                        <button onclick="window.changeMonth(1)" class="p-1 hover:bg-white rounded shadow-sm"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-black text-slate-300 mb-2">
                        <div>DOM</div><div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div>SAB</div>
                    </div>
                    <div class="grid grid-cols-7 gap-1">${grid}</div>
                    ${!state.pickerTarget ? `<button onclick="window.closeModal()" class="mt-6 w-full py-3 bg-navy text-white rounded-lg text-xs font-bold uppercase tracking-widest">Fechar</button>` : ''}
                </div>
            `);
        };

        window.toggleDateSelection = (d) => {
            if (state.pickerTarget) {
                if (state.pickerTarget.startsWith('TEMP_')) {
                    const f = state.pickerTarget.replace('TEMP_','');
                    state.tempAdvFilter[f] = d;
                    state.pickerTarget = null;
                    window.openAdvancedFilterModal(true);
                    return;
                }
                if (state.pickerTarget === 'evtDate') state.formTempDate = d;
                state.pickerTarget = null;
                window.closeModal();
                renderApp();
            } else {
                state.selectedDate = state.selectedDate === d ? null : d;
                window.openAgendaModal();
            }
        };

        window.changeMonth = (v) => { state.viewDate = new Date(state.viewDate.getFullYear(), state.viewDate.getMonth() + v, 1); window.openAgendaModal(); };

        // --- TIME PICKER ---
        window.openTimePickerModal = (t) => {
            state.timePickerTarget = t;
            const hours = Array.from({length: 24}, (_, i) => String(i).padStart(2, '0'));
            const minutes = Array.from({length: 12}, (_, i) => String(i * 5).padStart(2, '0')); 
            window.showModal(`
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-5 flex flex-col animate-in zoom-in">
                    <h3 class="font-bold text-navy uppercase text-sm mb-4">Escolha o Horário</h3>
                    <div class="flex gap-4 h-56">
                        <div class="flex-1 overflow-y-auto border rounded bg-slate-50 p-1">
                            ${hours.map(h => `<button onclick="window.confirmTime('${h}:00')" class="w-full py-2 text-sm hover:bg-navy hover:text-white rounded mb-1">${h}:00</button>`).join('')}
                        </div>
                    </div>
                    <button onclick="window.closeModal()" class="mt-4 w-full py-2 bg-slate-100 rounded font-bold text-xs uppercase">Cancelar</button>
                </div>
            `);
        };
        window.confirmTime = (val) => { if(state.timePickerTarget === 'evtTime') state.formTempTime = val; window.closeModal(); renderApp(); };

        // --- ADVANCED FILTER ---
        window.openAdvancedFilterModal = (restore = false) => {
            const af = restore ? state.tempAdvFilter : JSON.parse(JSON.stringify(state.advancedFilter));
            state.tempAdvFilter = af;
            
            const locs = state.locations.map(l => `<option value="${l.id}" ${af.valLoc === l.id ? 'selected' : ''}>${l.name}</option>`).join('');
            const types = state.types.map(t => `<option value="${t.id}" ${af.valType === t.id ? 'selected' : ''}>${t.name}</option>`).join('');
            const atts = state.attendants.map(a => `<option value="${a.id}" ${af.valAtt === a.id ? 'selected' : ''}>${a.name}</option>`).join('');

            window.showModal(`
                <div id="advanced-filter-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-md p-0 overflow-hidden flex flex-col max-h-[90vh] animate-in zoom-in">
                    <div class="p-4 border-b bg-navy text-white flex justify-between items-center">
                        <h3 class="font-bold text-sm flex items-center gap-2 uppercase tracking-tight"><i data-lucide="filter" class="w-4 h-4"></i> Filtro Avançado</h3>
                        <button onclick="window.closeModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-5 overflow-y-auto flex-1 flex flex-col gap-5 bg-slate-50">
                        <div class="bg-white p-3 rounded-lg border">
                            <label class="flex items-center gap-2 text-xs font-black text-navy uppercase mb-3"><input type="checkbox" ${af.useStatus ? 'checked' : ''} onchange="window.state.tempAdvFilter.useStatus=this.checked; window.openAdvancedFilterModal(true)"> Filtrar Status</label>
                            <div class="flex gap-4 ${!af.useStatus ? 'opacity-30 pointer-events-none' : ''}">
                                <label class="flex items-center gap-2 text-xs"><input type="radio" name="st" value="active" ${af.statusVal==='active'?'checked':''} onchange="window.state.tempAdvFilter.statusVal='active'"> Ativos</label>
                                <label class="flex items-center gap-2 text-xs"><input type="radio" name="st" value="inactive" ${af.statusVal==='inactive'?'checked':''} onchange="window.state.tempAdvFilter.statusVal='inactive'"> Inativos</label>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <label class="flex items-center gap-2 text-xs font-black text-navy uppercase mb-3"><input type="checkbox" ${af.useLoc ? 'checked' : ''} onchange="window.state.tempAdvFilter.useLoc=this.checked; window.openAdvancedFilterModal(true)"> Filtrar Local</label>
                            <select onchange="window.state.tempAdvFilter.valLoc=this.value" class="w-full p-2 border rounded text-xs ${!af.useLoc ? 'opacity-30 pointer-events-none' : ''}"><option value="">Selecione...</option>${locs}</select>
                        </div>
                        <div class="bg-white p-3 rounded-lg border">
                            <label class="flex items-center gap-2 text-xs font-black text-navy uppercase mb-3"><input type="checkbox" ${af.useDate ? 'checked' : ''} onchange="window.state.tempAdvFilter.useDate=this.checked; window.openAdvancedFilterModal(true)"> Filtrar Período</label>
                            <div class="flex gap-2 ${!af.useDate ? 'opacity-30 pointer-events-none' : ''}">
                                <button onclick="window.state.pickerTarget='TEMP_dateStart'; window.openAgendaModal()" class="flex-1 p-2 border rounded text-[10px] text-left">${af.dateStart ? formatDateFull(af.dateStart) : 'Início'}</button>
                                <button onclick="window.state.pickerTarget='TEMP_dateEnd'; window.openAgendaModal()" class="flex-1 p-2 border rounded text-[10px] text-left">${af.dateEnd ? formatDateFull(af.dateEnd) : 'Fim'}</button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t flex gap-3">
                        <button onclick="window.closeModal()" class="flex-1 py-3 text-xs font-bold text-slate-400 uppercase">Cancelar</button>
                        <button onclick="window.applyAF()" class="flex-1 py-3 bg-navy text-white rounded-lg text-xs font-bold uppercase shadow-lg">Aplicar</button>
                    </div>
                </div>
            `);
        };

        window.applyAF = () => {
            state.advancedFilter = JSON.parse(JSON.stringify(state.tempAdvFilter));
            state.advancedFilter.active = true;
            state.searchTerm = '';
            state.selectedDate = null;
            window.closeModal();
            renderApp();
        };

        // --- ROW CRUD ---
        window.startCreateRow = () => { state.isCreatingRow = true; state.editingRowId = null; state.tempName = ''; state.tempSigla = ''; renderApp(); };
        window.startEditRow = (id) => { 
            const key = state.currentScreen;
            const item = state[key].find(i => i.id === id);
            if(item) { state.isCreatingRow = false; state.editingRowId = id; state.tempName = item.name; state.tempSigla = item.sigla || ''; renderApp(); }
        };
        window.cancelGenericEdit = () => { state.isCreatingRow = false; state.editingRowId = null; renderApp(); };
        window.saveGenericRow = async (id, hasSigla) => {
            const key = state.currentScreen;
            const payload = { name: state.tempName.trim() };
            if (hasSigla === 'true') payload.sigla = state.tempSigla.trim().toUpperCase();
            if (!payload.name) return alert("O nome é obrigatório.");
            try {
                id ? await db.collection(key).doc(id).update(payload) : await db.collection(key).add(payload);
                window.cancelGenericEdit();
            } catch (err) { alert("Erro ao salvar."); }
        };
        window.requestDeleteRow = (id, key, name) => {
            if(confirm(`Excluir "${name}" permanentemente?`)) {
                db.collection(key).doc(id).delete().catch(() => alert("Erro de permissão."));
            }
        };

        // --- FORM SAVE ---
        window.openFormDate = () => { state.pickerTarget = 'evtDate'; window.openAgendaModal(); };
        window.saveEvent = async () => {
            const payload = {
                date: state.formTempDate,
                time: state.formTempTime,
                locationId: document.getElementById('evtLoc').value,
                typeId: document.getElementById('evtType').value,
                attendantId: document.getElementById('evtAtt').value
            };
            if (!payload.date || !payload.locationId || !payload.typeId) return alert("Preencha todos os campos obrigatórios (*).");
            try {
                state.editingEventId ? await db.collection("agenda").doc(state.editingEventId).update(payload) : await db.collection("agenda").add(payload);
                window.navigateTo('home');
            } catch(e) { alert("Erro ao salvar."); }
        };
        window.deleteEvent = async () => {
            if(confirm("Deseja excluir este evento?")) {
                await db.collection("agenda").doc(state.editingEventId).delete();
                window.navigateTo('home');
            }
        };

        // --- RELATÓRIOS ---
        window.openPDFPreview = () => {
            const filtered = getFilteredEvents();
            const desc = getFilterDescription();
            const dateStr = new Date().toLocaleString();
            
            const rows = filtered.map(e => {
                const type = state.types.find(t => t.id === e.typeId);
                const loc = state.locations.find(l => l.id === e.locationId);
                const att = state.attendants.find(a => a.id === e.attendantId);
                return `
                    <tr class="border-b text-[10px] sm:text-xs">
                        <td class="py-2 px-1 font-bold whitespace-nowrap">${formatDateFull(e.date)}</td>
                        <td class="py-2 px-1">${e.time}</td>
                        <td class="py-2 px-1 font-black text-navy uppercase">${type?.name || '-'}</td>
                        <td class="py-2 px-1">${loc?.name || '-'}</td>
                        <td class="py-2 px-1 text-slate-400">${att?.name || '-'}</td>
                    </tr>`;
            }).join('');

            window.showModal(`
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col max-h-[90vh] animate-in zoom-in overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-navy flex items-center gap-2 uppercase text-xs"><i data-lucide="file-text"></i> Visualizar Relatório</h3>
                        <button onclick="window.closeModal()"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 sm:p-8 bg-slate-100">
                        <div id="report-capture-area" class="bg-white shadow-xl p-8 rounded-lg border border-slate-200 mx-auto max-w-[800px]">
                            <div class="text-center mb-10 pb-6 border-b border-dashed">
                                <h2 class="text-2xl font-black text-navy uppercase tracking-tighter mb-1">Relatório de Eventos</h2>
                                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest">Adm Valente</h3>
                                <div class="mt-4 text-[9px] text-slate-400 font-bold uppercase tracking-widest">${dateStr}</div>
                                <div class="mt-2 inline-block px-4 py-1 bg-navy text-white text-[9px] font-black uppercase rounded-full">${desc}</div>
                            </div>
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-navy text-white text-[9px] uppercase font-black tracking-widest">
                                        <th class="p-2">DATA</th><th class="p-2">HORA</th><th class="p-2">EVENTO</th><th class="p-2">LOCAL</th><th class="p-2">ATENDENTE</th>
                                    </tr>
                                </thead>
                                <tbody>${rows || '<tr><td colspan="5" class="p-10 text-center text-slate-300 italic">Sem registros.</td></tr>'}</tbody>
                            </table>
                            <div class="mt-6 text-right text-[10px] font-black text-navy border-t pt-4">TOTAL: ${filtered.length} REGISTROS</div>
                        </div>
                    </div>
                    <div class="p-4 bg-white border-t flex flex-wrap gap-2 justify-end shrink-0">
                        <button onclick="window.confirmPNGDownload()" class="px-5 py-2.5 bg-navy text-white rounded-lg text-xs font-black uppercase tracking-widest shadow hover:bg-navy-dark flex items-center gap-2">
                             <i data-lucide="image" class="w-4 h-4"></i> Baixar PNG
                        </button>
                        <button onclick="window.confirmPDFDownload()" class="px-5 py-2.5 bg-navy text-white rounded-lg text-xs font-black uppercase tracking-widest shadow hover:bg-navy-dark flex items-center gap-2">
                             <i data-lucide="download" class="w-4 h-4"></i> Baixar PDF
                        </button>
                    </div>
                </div>
            `);
        };

        window.confirmPDFDownload = () => {
            const doc = new jspdf.jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            doc.setFontSize(18);
            doc.setTextColor(0, 51, 102); 
            doc.text("Relatório de Eventos - Adm Valente", pageWidth / 2, 20, { align: 'center' }); 
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(getFilterDescription(), pageWidth / 2, 28, { align: 'center' }); 
            
            const filtered = getFilteredEvents();
            const data = filtered.map(e => {
                const type = state.types.find(t => t.id === e.typeId);
                const loc = state.locations.find(l => l.id === e.locationId);
                const att = state.attendants.find(a => a.id === e.attendantId);
                return [formatDateFull(e.date), e.time, type?.name || '-', loc?.name || '-', att?.name || '-'];
            });
            
            doc.autoTable({
                startY: 35,
                head: [['DATA', 'HORA', 'EVENTO', 'LOCAL', 'ATENDENTE']],
                body: data,
                theme: 'grid',
                headStyles: { fillColor: [0, 51, 102], textColor: 255, fontSize: 11, fontStyle: 'bold' },
                styles: { fontSize: 9 }
            });
            doc.save(`agenda-adm-valente-${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.confirmPNGDownload = () => {
            const area = document.getElementById('report-capture-area');
            html2canvas(area, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const link = document.createElement('a');
                link.download = `relatorio-${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        /**
         * ==========================================
         * 6. INITIALIZATION
         * ==========================================
         */
        (async function init() {
            await initPersistence();

            // Listen Auth
            auth.onAuthStateChanged(user => {
                state.user = user ? { uid: user.uid, email: user.email } : null;
                state.isAdmin = user?.uid === ADMIN_UID;
                document.getElementById('initial-loading')?.classList.add('hidden');
                renderApp();
            });

            // Listen Data
            const collections = ['agenda', 'types', 'locations', 'attendants'];
            const stateMap = { agenda: 'events', types: 'types', locations: 'locations', attendants: 'attendants' };
            collections.forEach(col => {
                db.collection(col).onSnapshot(snap => {
                    state[stateMap[col]] = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });
            });

            // Popstate handling (Basic Routing)
            window.addEventListener('popstate', () => { window.navigateTo('home'); });
        })();
    </script>
</body>
</html>
